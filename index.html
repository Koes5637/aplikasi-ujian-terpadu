<!-- Ini adalah file aplikasi Ujian Hybrid fungsional. -->
<!-- Termasuk: Tailwind CSS, MathJax, Chart.js, Firebase V8 SDK, dan logika Anti-Curang/Gemini API. -->
<!-- Fitur: Sinkronisasi Offline Otomatis, Dasbor Analitik, MONITORING REAL-TIME. -->
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ujian Hybrid (Final Otomatis)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- MathJax Setup -->
    <script>
        MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] }, svg: { fontCache: 'global' } };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    
    <!-- FITUR BARU: Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs (v8 CDN) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* Desain Umum dan Responsif */
        body { font-family: 'Inter', sans-serif; background-color: #1E1A3C; color: #E5E7EB; margin: 0; padding: 0; }
        .screen { display: none; }
        .screen.active { 
            display: flex; /* Mengubah dari block ke flex untuk centering */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .dark-card { 
            background-color: rgb(34, 30, 54); 
            border-radius: 1rem; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 5px 10px rgba(0, 0, 0, 0.3); 
            border-top: 5px solid #6D28D9; 
        }
        .gradient-button { background: linear-gradient(90deg, #EC4899, #8B5CF6); color: white; transition: all 0.2s; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.5); }
        .gradient-button:hover { background: linear-gradient(90deg, #DB2777, #7C3AED); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.8); transform: translateY(-2px); }
        .gradient-button-secondary { background: linear-gradient(90deg, #06B6D4, #3B82F6); color: white; transition: all 0.2s; box-shadow: 0 4px 10px rgba(60, 150, 250, 0.4); }
        .gradient-button-secondary:hover { background: linear-gradient(90deg, #0891B2, #2563EB); transform: translateY(-1px); }
        .teacher-link { color: #A78BFA; transition: color 0.2s; }
        .teacher-link:hover { color: #C4B5FD; text-decoration: underline; }
        .dark-input { background-color: rgb(44, 39, 70); border: 2px solid #5B21B6; color: white; padding: 12px 16px; border-radius: 0.5rem; }
        .dark-input:focus { outline: none; border-color: #A78BFA; box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.5); }
        
        /* Quiz Options Styling */
        .quiz-option { 
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s; 
            border-color: #4B5563; 
            background-color: rgb(44, 39, 70); 
            color: #E5E7EB; 
            cursor: pointer;
            word-wrap: break-word; 
        }
        .quiz-option:hover { background-color: rgb(54, 48, 86); border-color: #6B7280; }
        
        /* MC Single Select */
        .quiz-option.selected.mc-single, .quiz-option.selected.mc-single:hover, .quiz-option.selected.mc-single:active { 
            background-color: #A78BFA !important; 
            color: #1E1A3C !important; 
            border-color: #8B5CF6 !important; 
        }
        
        /* MC Complex Select */
        .quiz-option.selected.mc-complex, .quiz-option.selected.mc-complex:hover, .quiz-option.selected.mc-complex:active { 
            background-color: #10B981 !important; /* Hijau */
            color: #1E1A3C !important; 
            border-color: #059669 !important; 
        }

        .question-image, .option-image { max-width: 100%; max-height: 200px; border-radius: 0.5rem; margin-top: 0.5rem; }
        #teacher-pin-input { letter-spacing: 1em; padding-left: 1.5em; }
        #equation-preview, #modal-math-preview, #exam-question-preview, .math-preview-option { 
            font-size: 1.1rem; 
            min-height: 40px; 
            padding: 0.5rem; 
            border: 1px dashed #6D28D9; 
            border-radius: 0.5rem; 
            margin-top: 0.5rem; 
            background-color: rgb(34, 30, 54); 
            overflow-x: auto; /* Untuk rumus yang sangat panjang */
        }
        .math-keyboard-btn { transition: all 0.2s ease-in-out; background-color: #4A5568; color: white; }
        .math-keyboard-btn:hover { transform: scale(1.05); background-color: #2D3748; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .math-keyboard-btn:active { transform: scale(0.98); }
        .math-keyboard-btn.op-btn { background-color: #5B21B6; }
        .math-keyboard-btn.func-btn { background-color: #16A34A; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        #exam-code-input { letter-spacing: 0.2em; }
        
        /* Grid Layout untuk Layar Ujian */
        .quiz-container { display: grid; grid-template-columns: 1fr; gap: 1rem; max-width: 1000px; width: 100%; margin: auto; }
        @media (min-width: 768px) {
            .quiz-container { grid-template-columns: 3fr 1fr; }
        }
        
        /* Pastikan elemen di layar editor tidak terlalu lebar */
        #question-editor-screen, #teacher-dashboard-screen, #question-bank-screen, #score-recap-screen, #student-review-screen, #analytics-dashboard-screen, #live-monitoring-screen {
            max-width: 1000px;
            width: 100%;
            margin: auto;
        }
        
        /* Style untuk penempatan Keyboard Virtual */
        .kv-container { position: relative; margin-top: 0.5rem; }
        .kv-toggle-btn { margin-left: 0.5rem; }
        .kv-keyboard {
            background-color: #2D3748; 
            border-radius: 0.5rem; 
            padding: 0.5rem;
            position: absolute; /* Tetapkan posisi absolut di dalam div */
            z-index: 20; /* Pastikan di atas elemen lain */
            width: 100%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            display: none; /* Default tersembunyi */
            top: 100%; /* Tempatkan di bawah tombol pemicu */
            left: 0;
            margin-top: 5px;
        }
        
        /* Style untuk Tabel Siswa */
        .student-table {
            width: 100%;
            border-collapse: collapse;
        }
        .student-table th, .student-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #374151;
        }
        .student-table th {
            background-color: #374151;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        /* Indikator Status Jaringan */
        #network-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 1000;
            transition: background-color 0.3s;
        }
        #network-status.online { background-color: #10B981; color: white; }
        #network-status.offline { background-color: #F59E0B; color: #1E1A3C; }
        
        /* Gaya Khusus Monitoring */
        .status-focused { color: #10B981; font-weight: bold; }
        .status-unfocused { color: #F59E0B; font-weight: bold; }
        .status-blocked { color: #EF4444; font-weight: bold; animation: pulse-red 1s infinite; }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8 min-h-screen">

        <!-- Indikator Status Jaringan -->
        <div id="network-status">Memeriksa koneksi...</div>

        <!-- Notifikasi / Konfirmasi Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
            <div class="dark-card p-6 w-full max-w-sm mx-auto transform transition-all">
                <div class="flex items-center space-x-3 mb-4">
                    <span id="modal-icon" class="w-8 h-8 text-yellow-500 flex items-center justify-center">⚠️</span>
                    <h3 class="text-xl font-bold text-white" id="modal-title">Konfirmasi</h3>
                </div>
                <p id="modal-message" class="text-gray-300 mb-6"></p>
                <div id="modal-actions" class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 rounded-lg text-gray-400 hover:text-white transition">Batal</button>
                    <button id="modal-confirm" class="gradient-button px-4 py-2 rounded-lg">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
        
        <!-- PREVIEW MODAL (STATIS) -->
        <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
            <div id="modal-content-card" class="dark-card p-6 w-full max-w-xl mx-auto transform transition-all max-h-[90vh] overflow-y-auto">
                <div id="preview-modal-content">
                    <!-- Content filled by JS -->
                </div>
                <div class="flex justify-end space-x-3 mt-4 pt-4 border-t border-gray-700">
                    <button onclick="hidePreviewModal()" class="gradient-button px-4 py-2 rounded-lg">Tutup</button>
                </div>
            </div>
        </div>

        <!-- STUDENT: LANDING SCREEN (Sederhana) -->
        <div id="student-landing-screen" class="screen active text-center">
             <div class="max-w-lg w-full mx-auto">
                 <h1 class="text-4xl font-extrabold text-white mb-6">Selamat Datang</h1>
                 <div class="dark-card p-8 space-y-4 mb-8">
                     <!-- Step 1: Find Student by NIS -->
                     <div id="student-find-step">
                         <p class="text-gray-400 mb-2">Masukkan Nomor Induk Siswa (NIS) Anda.</p>
                         <div class="flex gap-2">
                             <input type="text" id="student-id-input" placeholder="NIS" class="dark-input w-full" required>
                             <button id="find-student-btn" class="gradient-button px-6 rounded-xl">Cari</button>
                         </div>
                     </div>

                     <!-- Step 2: Confirm and Enter Exam Code -->
                     <div id="student-confirm-step" class="hidden space-y-4">
                         <div class="text-left p-4 bg-gray-800 rounded-lg">
                             <p class="text-sm text-gray-400">Nama Siswa</p>
                             <p id="confirm-student-name" class="text-xl font-bold"></p>
                             <p class="text-sm text-gray-400 mt-2">Kelas</p>
                             <p id="confirm-student-class" class="text-xl font-bold"></p>
                         </div>
                         <button onclick="resetStudentFind()" class="text-sm teacher-link">Bukan saya? Cari lagi.</button>
                         
                         <div class="pt-4 mt-4 border-t border-gray-700">
                             <p class="text-sm text-gray-400 mb-2">Kode Ujian (Kosongkan untuk Mode Offline)</p>
                             <input type="text" id="exam-code-input" placeholder="Kode Ujian" class="dark-input w-full text-center text-xl uppercase" maxlength="6">
                         </div>
                         
                         <button id="start-exam-flow-button" class="gradient-button w-full mt-4 py-3 rounded-xl flex items-center justify-center">
                             ▶️ Mulai Ujian
                         </button>
                     </div>
                 </div>
                 <p class="mt-8 text-sm text-gray-500">
                     Apakah Anda seorang Guru? 
                     <button onclick="showScreen('teacher-login-screen')" class="teacher-link">Masuk sebagai Guru</button>
                 </p>
             </div>
        </div>


        <!-- TEACHER: LOGIN SCREEN -->
        <div id="teacher-login-screen" class="screen">
            <div class="max-w-md w-full mx-auto text-center">
                <h1 class="text-3xl font-bold text-white mb-6">Akses Guru</h1>
                <div class="dark-card p-8 space-y-6">
                    <p class="text-gray-400">Masukkan PIN Rahasia untuk mengakses Dashboard Pengaturan.</p>
                    <input type="password" id="teacher-pin-input" placeholder="••••" class="dark-input w-full text-center text-3xl font-mono tracking-widest" maxlength="4" required>
                    <button onclick="checkTeacherPin()" class="gradient-button w-full py-3 rounded-xl flex items-center justify-center">
                        🔒 Masuk
                    </button>
                </div>
                <button onclick="showScreen('student-landing-screen')" class="teacher-link mt-6">Kembali ke Halaman Siswa</button>
            </div>
        </div>

        <!-- TEACHER: DASHBOARD -->
        <div id="teacher-dashboard-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-8">Dashboard Guru</h1>
            <div class="grid md:grid-cols-3 gap-6 w-full">
                <!-- Card 1: Pengaturan Ujian -->
                <button onclick="showScreen('exam-creator-screen')" class="dark-card p-6 flex flex-col items-center justify-center text-center transition hover:scale-[1.02]">
                    <span class="w-10 h-10 text-pink-400 mb-3 text-3xl">⚙️</span>
                    <h2 class="text-xl font-semibold">Buat & Atur Ujian</h2>
                    <p class="text-sm text-gray-400 mt-1">Siapkan soal, durasi, dan publikasikan ujian.</p>
                </button>
                
                <!-- Card 2: Bank Soal -->
                <button onclick="showScreen('question-bank-screen')" class="dark-card p-6 flex flex-col items-center justify-center text-center transition hover:scale-[1.02]">
                    <span class="w-10 h-10 text-cyan-400 mb-3 text-3xl">📚</span>
                    <h2 class="text-xl font-semibold">Bank Soal</h2>
                    <p class="text-sm text-gray-400 mt-1">Kelola, impor, dan ekspor koleksi soal.</p>
                </button>

                <!-- Card 3: Rekap Nilai -->
                <button onclick="showScreen('score-recap-screen')" class="dark-card p-6 flex flex-col items-center justify-center text-center transition hover:scale-[1.02]">
                    <span class="w-10 h-10 text-violet-400 mb-3 text-3xl">📊</span>
                    <h2 class="text-xl font-semibold">Rekap Nilai</h2>
                    <p class="text-sm text-gray-400 mt-1">Lihat hasil ujian (Online & Offline).</p>
                </button>
                
            </div>
            
            <div class="grid md:grid-cols-3 gap-6 w-full mt-6">
                <button onclick="showScreen('student-manager-screen')" class="dark-card p-6 flex flex-col items-center justify-center text-center transition hover:scale-[1.02]">
                    <span class="w-10 h-10 text-green-400 mb-3 text-3xl">🧑‍🎓</span>
                    <h2 class="text-xl font-semibold">Manajemen Siswa</h2>
                    <p class="text-sm text-gray-400 mt-1">Kelola daftar siswa yang terdaftar di database.</p>
                </button>
                
                <!-- FITUR BARU: Tombol Dasbor Analisis (NAMA SUDAH DIPERBAIKI) -->
                <button onclick="showScreen('analytics-dashboard-screen')" class="dark-card p-6 flex flex-col items-center justify-center text-center transition hover:scale-[1.02]">
                    <span class="w-10 h-10 text-blue-400 mb-3 text-3xl">📈</span>
                    <h2 class="text-xl font-semibold">Dashboard Analisis</h2>
                    <p class="text-sm text-gray-400 mt-1">Analisis ujian & performa siswa.</p>
                </button>
                
                <!-- FITUR BARU: Tombol Monitoring Ujian -->
                <button onclick="showScreen('live-monitoring-screen')" class="dark-card p-6 flex flex-col items-center justify-center text-center transition hover:scale-[1.02] border-t-4 border-red-500">
                    <span class="w-10 h-10 text-red-400 mb-3 text-3xl">🔴</span>
                    <h2 class="text-xl font-semibold">Monitoring Ujian</h2>
                    <p class="text-sm text-gray-400 mt-1">Lihat status pengerjaan dan fokus siswa (Real-Time).</p>
                </button>
            </div>

            <!-- Fitur Reset Ujian Siswa (SUDAH DIPINDAHKAN KE MONITORING) -->
            <!-- <div class="dark-card p-6 mt-6 w-full">...</div> -->

            <div class="mt-10 flex justify-start w-full">
                <button onclick="showConfirm('Anda yakin ingin keluar dari mode Guru?', () => showScreen('student-landing-screen'), null)" class="px-4 py-2 text-gray-400 rounded-lg hover:text-white transition">
                    Keluar (Log Out)
                </button>
            </div>
        </div>
        
        <!-- TEACHER: LIVE MONITORING SCREEN (BARU) -->
        <div id="live-monitoring-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-6">Monitoring Ujian</h1>
            
            <!-- FITUR RESET UJIAN DIPINDAHKAN KE SINI -->
            <div class="dark-card p-6 mt-6 w-full mb-6">
                <h2 class="text-xl font-bold mb-4">Reset Ujian Siswa (Online/Offline)</h2>
                <p class="text-sm text-gray-400 mb-3">Gunakan fitur ini untuk memberikan kesempatan ujian ulang kepada siswa yang sudah pernah mengerjakan ujian (jika ujian dibatasi) atau yang ujiannya terblokir.</p>
                <div class="flex flex-wrap items-center gap-4">
                    <input type="text" id="exam-id-for-reset" placeholder="Kode Ujian Target" class="dark-input w-40 text-sm">
                    <input type="text" id="student-nis-for-reset" placeholder="NIS Siswa Target" class="dark-input w-40 text-sm">
                    <input type="text" id="reset-auth-code-input" placeholder="Kode Reset/Unlock" class="dark-input w-40 text-sm">
                    <button onclick="resetStudentAttempt()" class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded-xl flex items-center transition text-sm">
                        🔄 Reset Kesempatan
                    </button>
                </div>
            </div>

            <div class="dark-card p-6 mb-6 w-full">
                <h2 class="text-xl font-semibold mb-4">Pilih Ujian yang Sedang Berjalan</h2>
                <div class="flex gap-4 mb-4">
                    <select id="live-exam-select" class="dark-input w-full" onchange="startLiveMonitoring(this.value)">
                        <option value="">Pilih Ujian...</option>
                    </select>
                    <button onclick="clearLiveMonitoringData()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-xl flex-shrink-0">
                        🗑️ Hapus Semua Data Live
                    </button>
                </div>

                <div id="live-monitoring-stats" class="grid grid-cols-2 gap-4 mt-4 text-center text-sm">
                    <div class="bg-gray-700 p-3 rounded-lg"><p class="text-gray-400">Total Peserta Online:</p><p id="live-stat-total" class="text-2xl font-bold text-blue-400">0</p></div>
                    <div class="bg-gray-700 p-3 rounded-lg"><p class="text-gray-400">Siswa Berpotensi Curang:</p><p id="live-stat-cheating" class="text-2xl font-bold text-red-400">0</p></div>
                </div>
            </div>
            
            <div class="dark-card p-6 w-full">
                <h2 class="text-xl font-bold mb-4">Status Siswa (Real-Time)</h2>
                <div id="live-monitoring-table-container" class="overflow-x-auto">
                    <p class="text-gray-500 italic" id="live-monitoring-status-text">Pilih ujian di atas untuk memulai monitoring.</p>
                    <table id="live-monitoring-table" class="student-table min-w-full divide-y divide-gray-700 hidden">
                        <!-- Tabel akan diisi secara dinamis -->
                    </table>
                </div>
            </div>
            
            <div class="flex justify-start mt-6 w-full">
                <button onclick="stopLiveMonitoring(); showScreen('teacher-dashboard-screen')" class="px-4 py-2 text-gray-400 rounded-lg hover:text-white transition">
                    ⬅️ Kembali ke Dashboard
                </button>
            </div>
        </div>

        <!-- TEACHER: STUDENT MANAGER SCREEN -->
        <div id="student-manager-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-6">Manajemen Data Siswa</h1>
            <!-- TOMBOL KEMBALI DIPINDAHKAN KE ATAS -->
            <div class="flex justify-start mb-6 w-full">
                <button onclick="showScreen('teacher-dashboard-screen')" class="px-4 py-2 text-gray-400 rounded-lg hover:text-white transition">
                    ⬅️ Kembali ke Dashboard
                </button>
            </div>
            
            <div class="dark-card p-6 mb-6 space-y-4 w-full">
                <h2 class="text-xl font-semibold mb-3">Tambah Siswa Baru</h2>
                <div class="grid md:grid-cols-4 gap-4">
                    <input type="text" id="new-student-name" placeholder="Nama Lengkap" class="dark-input col-span-1">
                    <input type="text" id="new-student-nis" placeholder="NIS/ID" class="dark-input">
                    <input type="text" id="new-student-class" placeholder="Kelas" class="dark-input">
                    <!-- Input URL Foto diganti dengan Input File Foto -->
                    <input type="file" accept="image/*" id="new-student-photo-upload" class="hidden" onchange="previewImage('new-student-photo-upload', 'new-student-photo-preview')">
                    <label for="new-student-photo-upload" class="gradient-button-secondary py-2 px-4 rounded-xl text-sm cursor-pointer flex items-center justify-center">
                        🖼️ Unggah Foto (Opsional)
                    </label>
                </div>
                <img id="new-student-photo-preview" class="question-image mt-2 hidden w-24 h-24 object-cover rounded-full" alt="Preview Foto Siswa">

                <button onclick="addStudentOnline()" class="gradient-button py-2 px-4 rounded-xl flex items-center justify-center mt-4">
                    ➕ Tambah Siswa
                </button>
            </div>
            
            <div class="dark-card p-6 mb-6 w-full">
                <h2 class="text-xl font-semibold mb-3">Impor Massal & Hapus Data</h2>
                <p class="text-sm text-gray-400 mb-2">Salin data dari Excel (3 atau 4 kolom: NIS, NAMA, KELAS, URL_FOTO) lalu tempel di bawah ini. *Perhatian: Impor foto hanya mendukung URL publik.</p>
                <textarea id="excel-import-data" class="dark-input w-full h-32 text-sm" placeholder="Contoh:&#10;2425.10.001	BUDI SANTOSO	XI-1	https://foto.sekolah.id/budi.png&#10;2425.10.002	CITRA LESTARI	XI-1"></textarea>
                <div class="flex flex-wrap gap-4 mt-3">
                    <button onclick="importFromExcel()" class="gradient-button-secondary py-2 px-4 rounded-xl">📤 Impor dari Teks</button>
                    <button onclick="deleteAllStudents()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-xl">🗑️ Hapus Semua Siswa</button>
                </div>
            </div>

            <div class="dark-card p-6 w-full">
                <h2 class="text-xl font-bold mb-4">Daftar Siswa Terdaftar (<span id="student-count">0</span>)</h2>
                
                <!-- FITUR BARU: Filter dan Sorting Siswa -->
                <div class="flex flex-wrap gap-4 mb-4 items-center">
                    <select id="student-class-filter" class="dark-input text-sm" onchange="renderStudentList(this.value)">
                        <option value="all">Filter Kelas (Semua)</option>
                        <!-- Opsi kelas diisi JS -->
                    </select>
                    <button onclick="sortStudentList('studentName')" class="gradient-button-secondary py-1 px-3 rounded-xl text-sm flex items-center">
                         Urutkan Nama <span id="sort-indicator" class="ml-2"></span>
                    </button>
                </div>
                
                <div id="student-list-container" class="overflow-x-auto">
                    <!-- Tabel siswa akan di-render di sini -->
                    <p class="text-gray-500 italic">Memuat data siswa...</p>
                </div>
            </div>

            <!-- Tombol kembali sudah dipindah ke atas -->
        </div>

        <!-- TEACHER: EXAM CREATOR/EDITOR -->
        <div id="exam-creator-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-6">Pengaturan Ujian</h1>
            <div class="dark-card p-6 mb-6 space-y-4 w-full">
                <input type="hidden" id="exam-id-input">
                <input type="text" id="exam-title-input" placeholder="Judul Ujian" class="dark-input w-full text-xl" value="Ujian Default">
                
                <div class="grid md:grid-cols-4 gap-4">
                    <input type="text" id="exam-password-input" placeholder="Password Ujian" class="dark-input" value="12345">
                    <input type="number" id="exam-duration-input" placeholder="Durasi (Menit)" class="dark-input" value="60">
                    <input type="number" id="exam-strikes-input" placeholder="Max Curang (3)" class="dark-input" value="3">
                    <input type="text" id="exam-code-lock-input" placeholder="Kode Reset/Unlock" class="dark-input" value="UNLOCK">
                </div>
                
                 <div class="mt-4">
                     <input type="text" id="exam-allowed-classes-input" placeholder="Batasi untuk Kelas (Contoh: XI-1, XI-2, XI-3). Kosongkan untuk semua kelas." class="dark-input w-full text-sm">
                 </div>
                
                <div class="flex flex-wrap items-center space-x-6 text-gray-300 pt-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="exam-shuffle-q-input" class="form-checkbox text-purple-600 rounded">
                        <span class="ml-2 text-sm">Acak Soal</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="exam-shuffle-o-input" class="form-checkbox text-purple-600 rounded">
                        <span class="ml-2 text-sm">Acak Opsi</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="exam-show-score-input" class="form-checkbox text-purple-600 rounded" checked>
                        <span class="ml-2 text-sm">Tampilkan Nilai</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="exam-limit-attempts-input" class="form-checkbox text-purple-600 rounded" checked>
                        <span class="ml-2 text-sm">Batasi 1x Ujian</span>
                    </label>
                    <!-- FITUR BARU: OPSI REVIEW -->
                    <label class="flex items-center">
                        <input type="checkbox" id="exam-show-review-input" class="form-checkbox text-blue-600 rounded" checked>
                        <span class="ml-2 text-sm">Tampilkan Tinjauan Kunci</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="exam-show-pembahasan-input" class="form-checkbox text-blue-600 rounded" checked>
                        <span class="ml-2 text-sm">Tampilkan Pembahasan</span>
                    </label>
                </div>
                
                <div class="flex flex-wrap gap-4 pt-4 border-t border-gray-700">
                    <button onclick="addQuestion('exam')" class="gradient-button py-2 px-4 rounded-xl flex items-center">
                        ➕ Tambah Soal Baru
                    </button>
                    <button onclick="showScreen('question-bank-screen', 'exam')" class="gradient-button-secondary py-2 px-4 rounded-xl flex items-center">
                        📋 Ambil dari Bank Soal
                    </button>
                    <button onclick="publishExamOnline()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl flex items-center transition">
                        🌐 Publikasikan Ujian
                    </button>
                </div>
            </div>

            <!-- FITUR BARU: Panel Muat Ujian Lama -->
            <div class="dark-card p-6 mb-6 w-full border-t-4 border-cyan-500">
                <h2 class="text-xl font-bold mb-4">Muat Ujian yang Sudah Dipublikasi</h2>
                <p class="text-sm text-gray-400 mb-4">Pilih ujian untuk dimuat ke editor. Anda dapat mengeditnya (misal: ganti kelas) lalu mempublikasikannya sebagai ujian baru.</p>
                <button onclick="loadPublishedExams()" class="gradient-button-secondary py-2 px-4 rounded-xl mb-4">Muat Ulang Daftar Ujian</button>
                <div id="published-exams-list" class="space-y-3 max-h-48 overflow-y-auto">
                    <p class="text-gray-500 italic">Memuat ujian...</p>
                </div>
            </div>

            <!-- List Soal Ujian -->
            <div class="dark-card p-6 w-full">
                <h2 class="text-xl font-bold mb-4">Daftar Soal Ujian Saat Ini (<span id="exam-question-count">0</span> Soal)</h2>
                <div id="exam-question-list" class="space-y-4">
                    <p class="text-gray-500 italic">Belum ada soal. Silakan tambahkan soal di atas.</p>
                </div>
            </div>

            <div class="flex justify-start mt-6 w-full">
                <button onclick="showScreen('teacher-dashboard-screen')" class="px-4 py-2 text-gray-400 rounded-lg hover:text-white transition">
                    ⬅️ Kembali ke Dashboard
                </button>
            </div>
        </div>

        <!-- TEACHER: QUESTION EDITOR (Form) -->
        <div id="question-editor-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-6" id="editor-title">Tambah Soal Baru</h1>
            <div class="dark-card p-6 space-y-4 w-full">
                <!-- Tipe Soal -->
                <div>
                    <label class="block text-sm font-medium mb-1">Tipe Soal</label>
                    <select id="question-type" class="dark-input w-full">
                        <option value="mc">Pilihan Ganda (Satu Jawaban)</option>
                        <option value="mc-complex">Pilihan Ganda Kompleks (Banyak Jawaban)</option>
                        <option value="essay">Esai Singkat (dengan Kunci Jawaban)</option>
                        <option value="essay-complex">Esai Kompleks (Penilaian Manual)</option>
                        <option value="bs">Benar/Salah (BS)</option>
                    </select>
                </div>

                <!-- FITUR BARU: Tag Topik/Materi -->
                <div>
                    <label class="block text-sm font-medium mb-1">Tag Topik/Materi (Contoh: Aljabar, Hukum Newton)</label>
                    <input type="text" id="question-topic-tag" placeholder="Masukkan topik soal" class="dark-input w-full text-sm">
                </div>

                <!-- Soal Text & Math Editor -->
                <div id="question-text-group">
                    <label class="block text-sm font-medium mb-1">Teks Soal</label>
                    <textarea id="question-text-input" class="dark-input w-full h-32 text-sm" oninput="updateOptionMathPreview(this, 'equation-preview')" placeholder="Tulis soal di sini. Contoh: Berapakah nilai dari $\sum_{i=1}^{n} i$?"></textarea>
                    
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex items-center space-x-2">
                            <!-- Tombol Toggle KV -->
                            <button onclick="toggleKV('question-text-input', this)" class="gradient-button-secondary py-1 px-3 rounded-lg text-sm flex items-center kv-toggle-btn">
                                ⌨️ KV Math
                            </button>
                            <!-- Tombol Image Insert -->
                            <label for="question-image-upload" class="bg-indigo-600 hover:bg-indigo-700 text-white py-1 px-3 rounded-lg text-sm cursor-pointer flex items-center">
                                🖼️ Insert Image
                            </label>
                            <input type="file" accept="image/*" id="question-image-upload" class="hidden" onchange="previewImage('question-image-upload', 'question-image-preview')">
                            <button onclick="removeImage('question-image-upload', 'question-image-preview')" class="text-red-400 hover:text-red-500 text-sm">
                                Hapus
                            </button>
                        </div>
                        <p class="text-xs text-gray-400">Preview Rumus di Bawah:</p>
                    </div>
                    
                    <img id="question-image-preview" class="question-image mt-2 hidden" alt="Preview Gambar Soal">
                    <div id="equation-preview"></div>
                </div>

                <!-- FITUR BARU: Pembahasan Soal -->
                <div id="question-pembahasan-group">
                    <label class="block text-sm font-medium mb-1">Pembahasan Soal (Opsional)</label>
                    <textarea id="question-pembahasan-input" class="dark-input w-full h-24 text-sm" oninput="updateOptionMathPreview(this, 'pembahasan-preview')" placeholder="Tulis pembahasan atau penjelasan jawaban di sini..."></textarea>
                    <!-- PERBAIKAN: Menambahkan tombol KV untuk Pembahasan -->
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleKV('question-pembahasan-input', this)" class="gradient-button-secondary py-1 px-3 rounded-lg text-sm flex items-center kv-toggle-btn">
                                ⌨️ KV Math
                            </button>
                        </div>
                        <p class="text-xs text-gray-400">Preview Pembahasan di Bawah:</p>
                    </div>
                    <div id="pembahasan-preview" class="math-preview-option"></div>
                </div>

                <!-- Math Keyboard (KV) - GLOBAL / STATIC -->
                <div id="math-keyboard" class="grid grid-cols-10 gap-2 p-2 dark-card bg-gray-800 border-none hidden">
                    <!-- Row 1: Basic Ops & Greek -->
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn" data-insert="^">xᵃ</button>
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn" data-insert="_">xₐ</button>
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn" data-insert="\frac{}{}">a/b</button>
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn" data-insert="\sqrt{}">√a</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\alpha">α</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\beta">β</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\theta">θ</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\pi">π</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\circ">∘</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="^{\circ}">°</button>

                    <!-- Row 2: Calculus & Logic -->
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn" data-insert="\sum_{}^{}">Σ</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\int">∫</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\int_{}^{} ">∫ₐᵇ</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\log">log</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="=">=</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\neq">≠</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\leq">≤</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\geq">≥</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\in">∈</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\angle">∠</button>

                    <!-- Row 3: Matrices & Misc -->
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn" data-insert="\begin{pmatrix} a & b \\ c & d \end{pmatrix}">(A)</button>
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn" data-insert="\begin{bmatrix} a & b \\ c & d \end{bmatrix}">[A]</button>
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn" data-insert="\begin{vmatrix} a & b \\ c & d \end{vmatrix}">|A|</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="\cdot">⋅</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="^2">x²</button>
                    <button class="math-keyboard-btn py-2 rounded-lg func-btn" data-insert="^3">x³</button>
                    <button class="math-keyboard-btn py-2 rounded-lg op-btn col-span-4" data-insert="\ ">Spasi</button>
                </div>
                
                <!-- Pilihan Ganda (MC) Container -->
                <div id="mc-options-container">
                    <h4 class="text-lg font-semibold mt-4 mb-2">Opsi Jawaban (<span id="mc-option-mode-text">Pilihan Ganda</span>)</h4>
                    <div id="mc-options-list" class="space-y-3">
                        <!-- Opsi akan di-render di sini -->
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mt-3">
                        <button onclick="addMcOption()" class="gradient-button-secondary py-2 px-4 rounded-lg text-sm flex items-center">
                            ➕ Tambah Opsi
                        </button>
                        <!-- FITUR GEMINI API -->
                        <button onclick="generateDistractor()" id="generate-distractor-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 py-2 px-4 rounded-lg text-sm flex items-center transition">
                            ✨ Buat Pengecoh Otomatis (AI)
                        </button>
                    </div>
                </div>

                <!-- Esai Answer Container -->
                <div id="essay-answer-container" class="hidden">
                    <h4 class="text-lg font-semibold mt-4 mb-2">Kunci Jawaban Esai Singkat</h4>
                    <textarea id="essay-answer-key" class="dark-input w-full h-24 text-sm" placeholder="Tulis poin-poin kunci jawaban esai di sini..."></textarea>
                    <p class="text-sm text-gray-400 mt-1">Jawaban esai akan dinilai manual. Teks ini hanya panduan.</p>
                </div>

                <!-- Benar/Salah (BS) Container -->
                <div id="bs-container" class="hidden">
                    <h4 class="text-lg font-semibold mt-4 mb-2">Pernyataan Benar/Salah</h4>
                    <div id="bs-statements-list" class="space-y-3">
                        <!-- Pernyataan akan di-render di sini -->
                    </div>
                    <button onclick="addBsStatement()" class="gradient-button-secondary py-2 px-4 rounded-lg mt-3 text-sm flex items-center">
                        ➕ Tambah Pernyataan
                    </button>
                </div>

                <!-- TOMBOL KEMBALI TELAH DIPERJELAS -->
                <div class="flex justify-between pt-4 border-t border-gray-700">
                    <button id="cancel-edit-btn" onclick="cancelEdit()" class="px-4 py-2 rounded-xl text-white bg-red-600 hover:bg-red-700 transition flex items-center">
                        ❌ Batal & Kembali
                    </button>

                    <div class="flex space-x-3">
                        <button id="save-to-bank-btn" onclick="processQuestionSaving('bank')" class="gradient-button-secondary py-2 px-4 rounded-xl">
                            💾 Simpan ke Bank Soal
                        </button>
                        <button id="save-to-exam-btn" onclick="updateQuestionInExam()" class="gradient-button py-2 px-4 rounded-xl hidden">
                            💾 Perbarui Soal Ujian
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEACHER: QUESTION BANK -->
        <div id="question-bank-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-6">Bank Soal Lokal</h1>
            <input type="hidden" id="bank-return-screen" value="teacher-dashboard-screen">
            
            <div class="dark-card p-6 mb-6 w-full">
                <div class="flex flex-wrap gap-4 mb-4">
                    <button onclick="addQuestion('bank')" class="gradient-button py-2 px-4 rounded-xl flex items-center">
                        ➕ Buat Soal Baru
                    </button>
                    <label for="import-json-bank" class="gradient-button-secondary py-2 px-4 rounded-xl flex items-center cursor-pointer">
                        📥 Import JSON
                        <input type="file" id="import-json-bank" accept=".json" class="hidden" onchange="importBankFromJSON(event)">
                    </label>
                    <button onclick="exportBankToJSON()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-xl flex items-center transition">
                        📤 Export JSON
                    </button>
                    <button onclick="clearQuestionBank()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-xl flex items-center transition">
                        🗑️ Bersihkan Bank
                    </button>
                    <button id="bank-use-all-btn" onclick="useAllQuestionsFromBank()" class="bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded-xl flex items-center transition hidden">
                        ✅ Gunakan Semua
                    </button>
                </div>

                <p class="text-sm text-gray-400 mb-4">Total Soal di Bank: <span id="bank-question-count">0</span></p>

                <div id="question-bank-list" class="space-y-4">
                    <!-- List soal bank akan di-render di sini -->
                </div>
            </div>
            
            <div class="flex justify-start mt-6 w-full">
                <button onclick="showScreen(document.getElementById('bank-return-screen').value)" class="px-4 py-2 text-gray-400 rounded-lg hover:text-white transition">
                    ⬅️ Kembali
                </button>
            </div>
        </div>

        <!-- TEACHER: SCORE RECAP/ANALYSIS -->
        <div id="score-recap-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-6">Rekapitulasi Nilai (Otomatis)</h1>
            
            <div class="dark-card p-6 mb-6 w-full">
                <div class="flex flex-wrap gap-4 mb-4">
                    <button onclick="exportScoresToCSV()" class="gradient-button py-2 px-4 rounded-xl flex items-center">
                        📤 Export ke CSV
                    </button>
                    <button onclick="clearScoreRecap()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-xl flex items-center transition">
                        🗑️ Hapus Semua Rekap
                    </button>
                    
                    <select id="analysis-class-filter" class="dark-input" onchange="renderScoreAnalysis(this.value)">
                        <option value="all">Semua Kelas</option>
                        <!-- Opsi kelas akan di-generate oleh JS -->
                    </select>
                </div>

                <p class="text-sm text-gray-400 mb-4">Total Entri Nilai: <span id="recap-entry-count">0</span></p>

                <div id="score-analysis-container" class="space-y-4">
                    <!-- Analisis & List Nilai akan di-render di sini -->
                </div>
                
                <p class="text-xs text-gray-500 mt-6">Catatan: Rekap nilai ini mencakup hasil ujian Offline dan Online yang tersimpan di perangkat lokal.</p>
            </div>
            
            <div class="flex justify-start mt-6 w-full">
                <button onclick="showScreen('teacher-dashboard-screen')" class="px-4 py-2 text-gray-400 rounded-lg hover:text-white transition">
                    ⬅️ Kembali ke Dashboard
                </button>
            </div>
        </div>

        <!-- LAYAR BARU: DASBOR ANALISIS (NAMA SUDAH DIPERBAIKI) -->
        <div id="analytics-dashboard-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-6">Dashboard Analisis</h1>

            <!-- Tab Buttons -->
            <div class="w-full max-w-4xl mb-4">
                <div class="flex border-b border-gray-700">
                    <button id="tab-btn-exam" onclick="switchAnalyticsTab('exam')" class="py-2 px-4 text-blue-400 border-b-2 border-blue-400 font-semibold">Analisis Ujian</button>
                    <button id="tab-btn-student" onclick="switchAnalyticsTab('student')" class="py-2 px-4 text-gray-500">Laporan Siswa</button>
                </div>
            </div>

            <div id="analytics-content" class="w-full">
                <!-- Tab 1: Analisis Ujian -->
                <div id="tab-panel-exam" class="space-y-6">
                    <div class="dark-card p-6">
                        <h2 class="text-xl font-semibold mb-4">Pilih Ujian untuk Dianalisis</h2>
                        <div class="flex gap-4">
                            <select id="analytics-exam-select" class="dark-input w-full">
                                <option value="">Memuat daftar ujian...</option>
                            </select>
                            <button onclick="runExamAnalysis()" class="gradient-button px-6 rounded-xl flex-shrink-0">Jalankan Analisis</button>
                        </div>
                    </div>
                    
                    <div id="exam-analytics-results" class="hidden space-y-6">
                        <!-- Statistik Ringkas -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="dark-card p-4 text-center border-t-4 border-blue-500">
                                <p class="text-sm text-gray-400">Total Peserta</p>
                                <p id="stat-total-students" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="dark-card p-4 text-center border-t-4 border-green-500">
                                <p class="text-sm text-gray-400">Nilai Rata-rata</p>
                                <p id="stat-avg-score" class="text-3xl font-bold">0.0</p>
                            </div>
                            <div class="dark-card p-4 text-center border-t-4 border-yellow-500">
                                <p class="text-sm text-gray-400">Nilai Tertinggi</p>
                                <p id="stat-high-score" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="dark-card p-4 text-center border-t-4 border-red-500">
                                <p class="text-sm text-gray-400">Nilai Terendah</p>
                                <p id="stat-low-score" class="text-3xl font-bold">0</p>
                            </div>
                        </div>

                        <!-- Grafik Distribusi Nilai -->
                        <div class="dark-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Distribusi Nilai</h3>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <canvas id="score-distribution-chart"></canvas>
                            </div>
                        </div>

                        <!-- Analisis Butir Soal -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="dark-card p-6">
                                <h3 class="text-lg font-semibold mb-4 text-red-400">5 Soal Paling Sulit (% Benar Terendah)</h3>
                                <div id="difficult-questions-list" class="space-y-2"></div>
                            </div>
                            <div class="dark-card p-6">
                                <h3 class="text-lg font-semibold mb-4 text-green-400">5 Soal Paling Mudah (% Benar Tertinggi)</h3>
                                <div id="easy-questions-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Laporan Siswa -->
                <div id="tab-panel-student" class="hidden space-y-6">
                    <div class="dark-card p-6">
                        <h2 class="text-xl font-semibold mb-4">Cari Siswa (berdasarkan NIS)</h2>
                        <div class="flex gap-4">
                            <input type="text" id="analytics-student-nis" placeholder="Masukkan NIS Siswa" class="dark-input w-full">
                            <button onclick="runStudentAnalysis()" class="gradient-button px-6 rounded-xl flex-shrink-0">Cari Siswa</button>
                        </div>
                    </div>

                    <div id="student-analytics-results" class="hidden space-y-6">
                        <!-- Kartu Profil Siswa -->
                        <div class="dark-card p-6 flex items-center gap-6">
                            <img id="student-profile-photo" src="https://placehold.co/100x100/332d5c/a78bfa?text=Foto" alt="Foto Siswa" class="w-24 h-24 rounded-full border-4 border-purple-500 object-cover">
                            <div>
                                <h3 id="student-profile-name" class="text-2xl font-bold">Nama Siswa</h3>
                                <p id="student-profile-class" class="text-lg text-gray-400">Kelas</p>
                                <p id="student-profile-nis" class="text-sm text-gray-500">NIS: </p>
                            </div>
                        </div>
                        
                        <!-- Grafik Perkembangan Nilai -->
                        <div class="dark-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Perkembangan Nilai Siswa</h3>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <canvas id="student-progress-chart"></canvas>
                            </div>
                        </div>

                        <!-- Riwayat Ujian -->
                        <div class="dark-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Riwayat Ujian</h3>
                            <div id="student-exam-history-list" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-start mt-6 w-full">
                <button onclick="showScreen('teacher-dashboard-screen')" class="px-4 py-2 text-gray-400 rounded-lg hover:text-white transition">
                    ⬅️ Kembali ke Dashboard
                </button>
            </div>
        </div>


        <!-- STUDENT: EXAM INTERFACE -->
        <div id="student-exam-screen" class="screen">
            <div class="quiz-container">
                <div class="dark-card p-6 col-span-1 md:col-span-3 lg:col-span-2">
                    <h1 class="text-2xl font-extrabold text-white mb-4" id="quiz-title"></h1>
                    
                    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                        <div class="text-lg font-medium text-gray-300">
                            Soal <span id="current-question-number"></span> dari <span id="total-questions"></span>
                        </div>
                        <div class="flex items-center space-x-2 text-red-400 font-bold">
                            🕒
                            <span id="quiz-timer"></span>
                        </div>
                    </div>
                    
                    <!-- Area Pertanyaan -->
                    <div id="question-area">
                        <div id="question-text" class="text-xl leading-relaxed mb-6"></div>
                        <img id="question-image-display" class="question-image hidden" alt="Gambar Pertanyaan">

                        <!-- Opsi Jawaban (MC/BS) -->
                        <div id="options-container" class="space-y-3">
                            <!-- Opsi akan di-render di sini -->
                        </div>
                        
                        <!-- Jawaban Esai -->
                        <div id="essay-input-container" class="hidden space-y-4">
                            <textarea id="essay-answer-input" class="dark-input w-full h-32 mt-4" placeholder="Tulis jawaban esai Anda di sini..."></textarea>
                            <!-- FITUR BARU: Upload Gambar Esai -->
                            <div id="essay-image-upload-container" class="hidden">
                                <label for="essay-image-upload" class="gradient-button-secondary py-2 px-4 rounded-lg text-sm cursor-pointer flex items-center justify-center">
                                    🖼️ Unggah Jawaban Gambar (Opsional)
                                </label>
                                <input type="file" accept="image/*" id="essay-image-upload" class="hidden">
                                <img id="essay-image-preview" class="option-image mt-2 hidden" alt="Preview Jawaban Gambar">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigasi Soal -->
                    <div class="flex justify-between mt-8 pt-4 border-t border-gray-700">
                        <button id="prev-question-btn" class="gradient-button-secondary py-2 px-4 rounded-xl disabled:opacity-50 flex items-center">
                            ← Sebelumnya
                        </button>
                        <button id="next-question-btn" class="gradient-button py-2 px-4 rounded-xl disabled:opacity-50 flex items-center">
                            Selanjutnya →
                        </button>
                        <button id="finish-exam-btn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-xl hidden flex items-center">
                            ✅ Selesai
                        </button>
                    </div>
                </div>

                <!-- Panel Navigasi Soal (Quick Jump) -->
                <div class="dark-card p-4 col-span-1 md:col-span-1 lg:col-span-1 mt-6 md:mt-0">
                    <h3 class="text-xl font-bold mb-4">Navigasi Soal</h3>
                    <div id="question-nav-panel" class="grid grid-cols-5 gap-2">
                        <!-- Tombol Navigasi akan di-render di sini -->
                    </div>
                </div>
            </div>
        </div>

        <!-- STUDENT: RESULT SCREEN -->
        <div id="student-result-screen" class="screen">
            <div class="max-w-md w-full mx-auto text-center">
                <h1 class="text-4xl font-extrabold text-green-400 mb-6">Ujian Selesai!</h1>
                <div class="dark-card p-8 space-y-4">
                    <h2 class="text-2xl font-semibold mb-4">Hasil Ujian</h2>
                    <p class="text-gray-300">Nama Siswa: <span id="result-student-name" class="font-bold"></span></p>
                    <p class="text-gray-300">Ujian: <span id="result-exam-title" class="font-bold"></span></p>
                    
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-6xl font-extrabold text-yellow-400" id="result-score">--</p>
                        <p class="text-lg font-medium text-gray-400">Nilai Anda</p>
                    </div>
                    
                    <p id="result-note" class="text-sm italic text-gray-500 mt-4"></p>
                    
                    <!-- Tombol Unduh Jawaban Dihapus -->
                    <div id="export-answer-container" class="mt-6 hidden"> </div>
                    
                    <button id="review-exam-btn" onclick="buildReviewScreen()" class="gradient-button-secondary w-full py-3 mt-4 rounded-xl hidden">
                        Lihat Tinjauan Ujian
                    </button>
                    
                    <button onclick="showScreen('student-landing-screen')" class="gradient-button w-full py-3 mt-6 rounded-xl">
                        Kembali ke Beranda
                    </button>
                </div>
            </div>
        </div>

        <!-- LAYAR BARU: STUDENT REVIEW SCREEN -->
        <div id="student-review-screen" class="screen">
            <h1 class="text-3xl font-bold text-white mb-6">Tinjauan Ujian</h1>
            <div id="review-container" class="w-full space-y-6">
                <!-- Konten review akan di-generate oleh JS di sini -->
            </div>
            <div class="flex justify-start mt-6 w-full">
                <button onclick="showScreen('student-result-screen')" class="px-4 py-2 text-gray-400 rounded-lg hover:text-white transition">
                    ⬅️ Kembali ke Hasil
                </button>
            </div>
        </div>

    </div>
    
    <script>
        // --- ALL APP LOGIC IS NOW IN THIS SINGLE SCRIPT BLOCK ---
        
        // --- DEKLARASI VARIABEL GLOBAL (Diperbaiki untuk konsolidasi dan hoisting) ---
        var TEACHER_PIN = "4897";
        var KEY_PREFIX = "hybrid_exam_"; // Untuk skor lokal
        var ANSWER_KEY_PREFIX = "examAnswers_"; // Untuk kunci jawaban
        var EXAM_COLLECTION = "ujian"; 
        var SCORE_COLLECTION = "scores";
        var STUDENT_COLLECTION = "siswa"; 
        var LIVE_MONITORING_COLLECTION = "live_status"; // KOLEKSI BARU UNTUK MONITORING
        var GEMINI_MODEL = "gemini-1.5-flash-latest";
        var API_KEY = ""; // <--- ISI KUNCI API ANDA DI SINI
        var API_URL_BASE = "https://generativelanguage.googleapis.com";
        var BATCH_RESULTS = []; // Untuk rekap massal

        // Variabel state aplikasi
        var currentScreen = 'student-landing-screen';
        var questionBank = [];
        var studentsData = [];
        var scoreRecap = [];
        var examData = { 
            examId: null, 
            title: 'Ujian Baru', 
            duration: 60, 
            password: '12345', 
            maxAttempts: 1, 
            resetCode: 'RESET', 
            shuffleQuestions: true, 
            shuffleOptions: true, 
            showScore: true, 
            maxStrikes: 3,
            unlockCode: 'UNLOCK', 
            limitAttempts: true,
            allowedClasses: [],
            showReview: true, // FITUR BARU
            showPembahasan: true, // FITUR BARU
            questions: [] 
        };
        var studentExamData = null; 
        var foundStudentData = null;
        var quizState = { currentQIndex: 0, answers: {}, timer: null, timeLeft: 0, totalSeconds: 0, strikes: 0, isLocked: false };
        var editingQuestionId = null; 
        var editingQuestionSource = null; 
        var currentEditingTextarea = null;
        var currentAnalysisFilter = 'all';
        // Variabel untuk menyimpan instance chart
        var scoreDistributionChart = null;
        var studentProgressChart = null;
        
        // Variabel untuk Live Monitoring
        var liveMonitoringExamId = null;
        var liveMonitoringUnsubscribe = null;
        var liveStatusInterval = null;

        // VARIABEL FIREBASE KRITIS
        var db, auth, userId, appId;
        var isOnline = navigator.onLine;
        var isAuthReady = false; 

        // VARIABEL BARU UNTUK SORTING SISWA
        var currentStudentSortKey = 'studentName'; 
        var currentStudentSortDirection = 'asc'; 


        // --- DEBOUNCE UTILITY ---
        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        // --- MATHJAX UTILITIES ---
        function updateOptionMathPreview(textareaElement, previewId) {
            const preview = document.getElementById(previewId);
            if (textareaElement && preview) {
                preview.innerHTML = textareaElement.value.replace(/\$/g, '$$');
                if (window.MathJax && MathJax.typesetPromise) {
                    MathJax.typesetPromise([preview]).catch(err => console.error("MathJax error on option:", err));
                }
            }
        }
        
        function insertAtCursor(textarea, textToInsert) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            // PERBAIKAN: Tombol spasi
            if (textToInsert === "\\ ") {
                textToInsert = " "; // Cukup masukkan spasi biasa
            }
            
            textarea.value = value.substring(0, start) + textToInsert + value.substring(end);
            
            // Atur posisi kursor
            let cursorPos = start + textToInsert.length;
            if (textToInsert.includes('}{')) {
                cursorPos = start + textToInsert.indexOf('}{') + 1;
            } else if (textToInsert.includes('\\begin{')) {
                 cursorPos = start + textToInsert.indexOf(' a ') + 1;
            }
            
            textarea.selectionStart = textarea.selectionEnd = cursorPos;
            textarea.focus();
        }
        
        // --- IMAGE UTILITIES ---
        
        function previewImage(fileInputId, previewElementId) {
            const fileInput = document.getElementById(fileInputId);
            const previewElement = document.getElementById(previewElementId);
            
            if (fileInput.files.length === 0) {
                previewElement.classList.add('hidden');
                previewElement.src = '';
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                previewElement.src = e.target.result;
                previewElement.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function removeImage(fileInputId, previewElementId) {
            const fileInput = document.getElementById(fileInputId);
            const previewElement = document.getElementById(previewElementId);
            
            if (fileInput) fileInput.value = null; 
            
            if (previewElement) {
                previewElement.classList.add('hidden');
                previewElement.src = '';
            }
        }
        
        function toggleKV(textareaId, buttonElement) {
            const textarea = document.getElementById(textareaId);
            const keyboard = document.getElementById('math-keyboard');
            
            currentEditingTextarea = textarea;

            if (keyboard.style.display === 'grid') {
                keyboard.style.display = 'none';
                buttonElement.textContent = '⌨️ KV Math';
            } else {
                document.querySelectorAll('.kv-keyboard').forEach(kv => kv.style.display = 'none');
                
                // Cari parent group terdekat untuk menempatkan keyboard
                const parentGroup = textarea.closest('#question-text-group, .bg-gray-700, #question-pembahasan-group');
                if(parentGroup) {
                    parentGroup.appendChild(keyboard);
                } else {
                    textarea.parentNode.appendChild(keyboard); // Fallback
                }
                
                keyboard.style.display = 'grid';
                buttonElement.textContent = '⌨️ Sembunyi';
            }

            if (textarea) textarea.focus();
        }


        // --- QUESTION SAVING LOGIC ---

        function finalizeQuestionAction(destination, question) {
            if (destination === 'bank') {
                if (editingQuestionId) {
                    const index = questionBank.findIndex(q => q.id === editingQuestionId);
                    if (index !== -1) questionBank[index] = question;
                } else {
                    questionBank.push(question);
                }
                saveQuestionBank();
                showConfirm("Soal berhasil disimpan ke Bank Soal Lokal.", null, () => showScreen('question-bank-screen'), false);
            } else if (destination === 'exam') {
                if (editingQuestionId) {
                    const index = examData.questions.findIndex(q => q.id === editingQuestionId);
                    if (index !== -1) examData.questions[index] = question;
                } else {
                    // Jika ini soal baru (bukan edit), tambahkan ke examData
                    examData.questions.push(question);
                }
                renderExamQuestionList();
                showConfirm("Soal berhasil disimpan ke Ujian.", null, () => showScreen('exam-creator-screen'), false);
            }
            clearQuestionForm();
        }

        function processQuestionSaving(destination) {
            const type = document.getElementById('question-type').value;
            const topicTag = document.getElementById('question-topic-tag').value.trim(); // Dapatkan nilai Tag Topik
            const text = document.getElementById('question-text-input').value.trim();
            const pembahasan = document.getElementById('question-pembahasan-input').value.trim();
            let isComplete = true;

            if (!text) {
                showConfirm("Teks soal tidak boleh kosong.", null, null, true);
                return;
            }
            if (!topicTag) {
                showConfirm("Tag Topik/Materi harus diisi untuk analisis penguasaan siswa.", null, null, true);
                return;
            }

            const questionImagePreview = document.getElementById('question-image-preview');
            const questionImageBase64 = questionImagePreview.classList.contains('hidden') ? null : questionImagePreview.src;

            const question = {
                id: editingQuestionId || Date.now().toString(),
                type: type,
                tag_topik: topicTag, // Simpan Tag Topik
                text: text,
                pembahasan: pembahasan, 
                image: questionImageBase64,
                options: [],
                answer: null 
            };
            
            if (type === 'mc' || type === 'mc-complex') {
                const optionElements = document.querySelectorAll('#mc-options-list > div');
                let correctCount = 0;
                let correctLabels = [];
                const inputSelector = (type === 'mc-complex' ? 'input[type="checkbox"]' : 'input[type="radio"]');

                optionElements.forEach((div, index) => {
                    const textarea = div.querySelector('textarea');
                    const input = div.querySelector(inputSelector);
                    const imagePreview = div.querySelector('img');

                    if (!textarea || !input || !imagePreview) return;

                    const optionText = textarea.value.trim();
                    const isCorrect = input.checked;
                    const label = String.fromCharCode(65 + index);
                    
                    const optionImageBase64 = imagePreview.classList.contains('hidden') ? null : imagePreview.src;

                    if (optionText || optionImageBase64) {
                        question.options.push({ 
                            text: optionText, 
                            isCorrect: isCorrect, 
                            label: label,
                            image: optionImageBase64
                        });
                        if (isCorrect) {
                            correctCount++;
                            correctLabels.push(label);
                        }
                    }
                });

                if (type === 'mc-complex') {
                    if (question.options.length < 3) {
                        showConfirm("Pilihan Ganda Kompleks harus memiliki minimal 3 opsi jawaban.", null, null, true);
                        isComplete = false;
                    }
                    if (correctCount < 1) {
                        showConfirm("Pilihan Ganda Kompleks harus memiliki minimal 1 kunci jawaban.", null, null, true);
                        isComplete = false;
                    }
                    if (isComplete) question.answer = correctLabels.sort(); 
                } else if (type === 'mc') {
                    if (question.options.length < 2 || correctCount !== 1) {
                        showConfirm("Pilihan Ganda (Satu Jawaban) harus memiliki minimal 2 opsi dan TEPAT 1 kunci jawaban.", null, null, true);
                        isComplete = false;
                    }
                    if (isComplete) question.answer = correctLabels[0]; 
                }
            } else if (type === 'essay') {
                const answerKey = document.getElementById('essay-answer-key').value.trim();
                if (!answerKey) {
                    showConfirm("Kunci Jawaban Esai Singkat harus diisi sebagai panduan penilaian.", null, null, true);
                    isComplete = false;
                }
                if (isComplete) question.answer = answerKey;
            } else if (type === 'essay-complex') {
                question.answer = "[MANUAL]"; // No answer key, just a marker
                isComplete = true; 
            } else if (type === 'bs') {
                const statementElements = document.querySelectorAll('#bs-statements-list > div');
                const answerKey = [];
                question.options = []; 

                statementElements.forEach((div, index) => {
                    const statementTextarea = div.querySelector('textarea[data-type="text"]');
                    const statementSelect = div.querySelector('select[data-type="isTrue"]');
                    const imagePreview = div.querySelector('img');
                    
                    if (!statementTextarea || !statementSelect || !imagePreview) return; 

                    const statementText = statementTextarea.value.trim();
                    const isTrue = statementSelect.value === 'true';
                    const statementImageBase64 = imagePreview.classList.contains('hidden') ? null : imagePreview.src;

                    if (statementText || statementImageBase64) {
                        question.options.push({ 
                            text: statementText, 
                            isTrue: isTrue, 
                            label: String(index + 1),
                            image: statementImageBase64 
                        });
                        answerKey.push(isTrue ? 'B' : 'S');
                    }
                });

                if (question.options.length === 0) {
                    showConfirm("Benar/Salah harus memiliki minimal 1 pernyataan.", null, null, true);
                    isComplete = false;
                }
                if (isComplete) question.answer = answerKey.join(''); 
            }
            
            if (!isComplete) return;

            finalizeQuestionAction(destination, question);
        }

        // --- UI & STATE FUNCTIONS ---
        
        function getStudentIdentifier(name, nis, studentClass) {
            return `${(name || 'Anonim').toUpperCase().replace(/\s/g, '_')}_${(nis || '0000').toUpperCase()}_${(studentClass || 'NON_KLAS').toUpperCase()}`;
        }

        function showConfirm(message, onConfirm, onCancel, isWarning = false) {
            const modal = document.getElementById('confirmation-modal');
            const titleElement = document.getElementById('modal-title');
            const messageElement = document.getElementById('modal-message');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            const icon = document.getElementById('modal-icon');

            titleElement.textContent = isWarning ? "Peringatan" : "Informasi";
            messageElement.textContent = message;
            icon.textContent = isWarning ? '❌' : '✅';
            icon.className = isWarning ? 'w-8 h-8 text-red-500 flex items-center justify-center' : 'w-8 h-8 text-green-500 flex items-center justify-center';
            
            const confirmAction = () => {
                modal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            const cancelAction = () => {
                modal.classList.add('hidden');
                if (onCancel) onCancel();
            };

            confirmBtn.onclick = confirmAction;
            cancelBtn.onclick = cancelAction;
            modal.classList.remove('hidden');
            
            if (!onConfirm) {
                cancelBtn.classList.add('hidden');
                confirmBtn.textContent = 'OK';
                confirmBtn.onclick = cancelAction;
            } else {
                cancelBtn.classList.remove('hidden');
                confirmBtn.textContent = 'Ya, Lanjutkan';
            }
        }

        function showScreen(screenId, secondaryAction = null) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            
            // HENTIKAN MONITORING saat pindah dari layar Live Monitoring
            if (currentScreen === 'live-monitoring-screen') {
                stopLiveMonitoring();
            }

            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                currentScreen = screenId;
            }

            if (screenId === 'student-landing-screen'){
                resetStudentFind(); // Selalu reset form siswa saat kembali ke halaman utama
            } else if (screenId === 'question-bank-screen') {
                if (secondaryAction === 'exam') {
                    document.getElementById('bank-return-screen').value = 'exam-creator-screen';
                    document.getElementById('bank-use-all-btn').classList.remove('hidden');
                } else {
                    document.getElementById('bank-return-screen').value = 'teacher-dashboard-screen';
                    document.getElementById('bank-use-all-btn').classList.add('hidden');
                }
                loadQuestionBank();
            } else if (screenId === 'exam-creator-screen') {
                renderExamQuestionList();
                loadPublishedExams(); // MEMUAT DAFTAR UJIAN ONLINE
            } else if (screenId === 'score-recap-screen') {
                loadScoreRecap();
            } else if (screenId === 'question-editor-screen') {
                if (!editingQuestionId) clearQuestionForm();
            } else if (screenId === 'student-manager-screen') {
                loadStudents();
            } else if (screenId === 'analytics-dashboard-screen') {
                // Saat pindah ke dasbor analitik, muat daftar ujian
                loadAnalyticsExams();
            } else if (screenId === 'live-monitoring-screen') {
                loadLiveMonitoringExams(); // MUAT DAFTAR UJIAN UNTUK MONITORING
            }
        }
        
        function checkTeacherPin() {
            const pinInput = document.getElementById('teacher-pin-input');
            if (pinInput.value === TEACHER_PIN) {
                showScreen('teacher-dashboard-screen');
                loadScoreRecap(); 
            } else {
                pinInput.value = '';
                pinInput.classList.add('shake');
                setTimeout(() => pinInput.classList.remove('shake'), 820);
                showConfirm("PIN Guru salah. Silakan coba lagi.", null, null, true);
            }
        }

        // --- DATA PERSISTENCE (LOCAL STORAGE) ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function loadQuestionBank() {
            try {
                const savedBank = localStorage.getItem('questionBank');
                questionBank = savedBank ? JSON.parse(savedBank) : [];
                renderQuestionBankList();
            } catch (e) {
                console.error("Gagal memuat Question Bank:", e);
                questionBank = [];
            }
        }

        function saveQuestionBank() {
            try {
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                renderQuestionBankList();
            } catch (e) {
                console.error("Gagal menyimpan Question Bank:", e);
                showConfirm("Gagal menyimpan data ke perangkat lokal. Penyimpanan mungkin penuh.", null, null, true);
            }
        }
        
        function clearQuestionBank() {
             showConfirm("Anda yakin ingin MENGHAPUS SEMUA soal di Bank Soal Lokal?", () => {
                 questionBank = [];
                 saveQuestionBank();
             }, null, true);
        }

        function clearQuestionForm() {
            document.getElementById('editor-title').textContent = "Tambah Soal Baru";
            document.getElementById('question-type').value = 'mc';
            document.getElementById('question-topic-tag').value = ''; // Clear Tag Topik
            document.getElementById('question-text-input').value = '';
            document.getElementById('question-pembahasan-input').value = '';
            document.getElementById('essay-answer-key').value = '';
            
            removeImage('question-image-upload', 'question-image-preview');
            
            document.getElementById('mc-options-list').innerHTML = '';
            document.getElementById('bs-statements-list').innerHTML = '';
            
            document.getElementById('save-to-exam-btn').classList.add('hidden');
            document.getElementById('save-to-bank-btn').classList.remove('hidden');
            
            for (var i = 0; i < 4; i++) addMcOption();
            
            document.getElementById('question-type').dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                document.querySelectorAll('#mc-options-list textarea, #bs-statements-list textarea, #question-text-input, #question-pembahasan-input').forEach(ta => {
                    if(ta) ta.dispatchEvent(new Event('input', { bubbles: true }));
                });
            }, 50);
            
            editingQuestionId = null;
            editingQuestionSource = null;
            
            const keyboard = document.getElementById('math-keyboard');
            if (keyboard) {
                keyboard.style.display = 'none';
            }
        }

        function addMcOption(optionData = { text: '', isCorrect: false, image: null }) {
            const list = document.getElementById('mc-options-list');
            const optionIndex = list.children.length;
            const type = document.getElementById('question-type').value;
            
            const inputType = (type === 'mc-complex' ? 'checkbox' : 'radio');
            const inputName = (type === 'mc-complex' ? `mc-correct-option-${optionIndex}` : 'mc-correct-option');
            
            const optionHtml = `
                <div class="flex space-x-2 items-start bg-gray-700 p-3 rounded-lg">
                    <input type="${inputType}" name="${inputName}" id="correct-${optionIndex}" class="form-input text-green-500 rounded mt-3 ${inputType === 'checkbox' ? '' : 'rounded-full'}" ${optionData.isCorrect ? 'checked' : ''}>
                    <div class="flex flex-col flex-grow">
                        <label for="correct-${optionIndex}" class="text-white text-sm font-bold">${String.fromCharCode(65 + optionIndex)}. Kunci Jawaban</label>
                        <textarea class="dark-input w-full h-12 text-sm mt-1" id="mc-text-${optionIndex}" oninput="updateOptionMathPreview(this, 'mc-preview-${optionIndex}')" data-option-index="${optionIndex}" placeholder="Teks Opsi Jawaban">${optionData.text}</textarea>
                        
                        <div class="flex flex-wrap items-center space-x-2 mt-2">
                            <button onclick="toggleKV('mc-text-${optionIndex}', this)" class="bg-indigo-700 hover:bg-indigo-800 text-white py-1 px-2 rounded-lg text-xs flex items-center">
                                ⌨️ KV
                            </button>
                            <label for="mc-image-upload-${optionIndex}" class="bg-purple-600 hover:bg-purple-700 text-white py-1 px-2 rounded-lg text-xs cursor-pointer flex items-center">
                                🖼️ Image
                            </label>
                            <input type="file" accept="image/*" id="mc-image-upload-${optionIndex}" class="hidden" onchange="previewImage('mc-image-upload-${optionIndex}', 'mc-image-preview-${optionIndex}')">
                            <button onclick="removeImage('mc-image-upload-${optionIndex}', 'mc-image-preview-${optionIndex}')" class="text-red-400 hover:text-red-500 text-xs">
                                Hapus Gambar
                            </button>
                        </div>

                        <img id="mc-image-preview-${optionIndex}" class="option-image mt-2 ${optionData.image ? '' : 'hidden'}" src="${optionData.image || ''}" alt="Preview Gambar Opsi">
                        <div id="mc-preview-${optionIndex}" class="math-preview-option">${optionData.text}</div>
                    </div>
                    <button onclick="this.parentNode.remove()" class="text-red-400 hover:text-red-500 transition mt-3">
                        🗑️
                    </button>
                </div>
            `;
            list.insertAdjacentHTML('beforeend', optionHtml);
        }

        function addBsStatement(statementData = { text: '', isTrue: false, image: null }) {
            const list = document.getElementById('bs-statements-list');
            const statementIndex = list.children.length;
            
            const optionHtml = `
                <div class="flex flex-col space-y-2 bg-gray-700 p-3 rounded-lg">
                    <div class="flex space-x-2 items-start">
                        <select class="dark-input text-sm mt-1" data-statement-index="${statementIndex}" data-type="isTrue">
                            <option value="true" ${statementData.isTrue ? 'selected' : ''}>Benar</option>
                            <option value="false" ${!statementData.isTrue ? 'selected' : ''}>Salah</option>
                        </select>
                        <div class="flex-grow">
                            <textarea class="dark-input w-full h-12 text-sm" id="bs-text-${statementIndex}" oninput="updateOptionMathPreview(this, 'bs-preview-${statementIndex}')" data-statement-index="${statementIndex}" data-type="text" placeholder="Teks Pernyataan Benar/Salah">${statementData.text}</textarea>
                        </div>
                        <button onclick="this.parentNode.parentNode.remove()" class="text-red-400 hover:text-red-500 transition mt-1">
                            🗑️
                        </button>
                    </div>
                    
                    <div class="flex flex-wrap items-center space-x-2 mt-2 pt-2 border-t border-gray-600">
                        <button onclick="toggleKV('bs-text-${statementIndex}', this)" class="bg-indigo-700 hover:bg-indigo-800 text-white py-1 px-2 rounded-lg text-xs flex items-center">
                            ⌨️ KV
                        </button>
                        <label for="bs-image-upload-${statementIndex}" class="bg-purple-600 hover:bg-purple-700 text-white py-1 px-2 rounded-lg text-xs cursor-pointer flex items-center">
                            🖼️ Image
                        </label>
                        <input type="file" accept="image/*" id="bs-image-upload-${statementIndex}" class="hidden" onchange="previewImage('bs-image-upload-${statementIndex}', 'bs-image-preview-${statementIndex}')">
                        <button onclick="removeImage('bs-image-upload-${statementIndex}', 'bs-image-preview-${statementIndex}')" class="text-red-400 hover:text-red-500 text-xs">
                            Hapus Gambar
                        </button>
                        <img id="bs-image-preview-${statementIndex}" class="option-image mt-2 ${statementData.image ? '' : 'hidden'}" src="${statementData.image || ''}" alt="Preview Gambar Pernyataan">
                    </div>
                    <div id="bs-preview-${statementIndex}" class="math-preview-option">${statementData.text}</div>
                </div>
            `;
            list.insertAdjacentHTML('beforeend', optionHtml);
        }
        
        // --- QUESTION BANK, EXAM EDITOR LOGIC ---
        
        function addQuestion(destination) {
            clearQuestionForm();
            showScreen('question-editor-screen');
            setTimeout(() => {
                currentEditingTextarea = document.getElementById('question-text-input');
                if (currentEditingTextarea) currentEditingTextarea.focus();
            }, 150);
        }

        function updateQuestionInExam() {
            processQuestionSaving('exam');
        }

        function cancelEdit() {
            if (editingQuestionSource === 'exam') {
                showScreen('exam-creator-screen');
            } else if (editingQuestionSource === 'bank') {
                showScreen('question-bank-screen');
            } else {
                showScreen('teacher-dashboard-screen');
            }
            clearQuestionForm();
        }

        function editQuestion(id, source) {
            editingQuestionId = id;
            editingQuestionSource = source;
            let question;

            if (source === 'bank') {
                question = questionBank.find(q => q.id === id);
                document.getElementById('save-to-bank-btn').classList.remove('hidden');
                document.getElementById('save-to-exam-btn').classList.add('hidden');
            } else if (source === 'exam') {
                question = examData.questions.find(q => q.id === id);
                document.getElementById('save-to-bank-btn').classList.add('hidden');
                document.getElementById('save-to-exam-btn').classList.remove('hidden');
            }
            
            if (question) {
                showScreen('question-editor-screen');
                document.getElementById('editor-title').textContent = "Edit Soal";
                document.getElementById('question-type').value = question.type;
                document.getElementById('question-topic-tag').value = question.tag_topik || ''; // Muat Tag Topik
                document.getElementById('question-text-input').value = question.text;
                document.getElementById('question-pembahasan-input').value = question.pembahasan || '';
                
                const imgPreview = document.getElementById('question-image-preview');
                if (question.image && question.image.startsWith('data:')) {
                    imgPreview.src = question.image;
                    imgPreview.classList.remove('hidden');
                } else {
                    removeImage('question-image-upload', 'question-image-preview');
                }
                
                document.getElementById('question-type').dispatchEvent(new Event('change')); 
                
                document.getElementById('mc-options-list').innerHTML = '';
                document.getElementById('bs-statements-list').innerHTML = '';
                
                if (question.type === 'mc' || question.type === 'mc-complex') {
                    const isComplex = question.type === 'mc-complex';
                    question.options.forEach(opt => {
                        let isCorrect = isComplex ? (question.answer && question.answer.includes(opt.label)) : (question.answer === opt.label);
                        addMcOption({ text: opt.text, isCorrect: isCorrect, image: opt.image || null });
                    });
                } else if (question.type === 'essay') {
                    document.getElementById('essay-answer-key').value = question.answer;
                } else if (question.type === 'bs') {
                    const answers = question.answer.split('');
                    question.options.forEach((stmt, index) => addBsStatement({ 
                        text: stmt.text, 
                        isTrue: answers[index] === 'B',
                        image: stmt.image || null 
                    }));
                }

                setTimeout(() => {
                    document.querySelectorAll('#mc-options-list textarea, #bs-statements-list textarea, #question-text-input, #question-pembahasan-input').forEach(ta => {
                        if(ta) ta.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                }, 100);
            }
        }
        
        function renderQuestionBankList() {
            const list = document.getElementById('question-bank-list');
            const count = document.getElementById('bank-question-count');
            list.innerHTML = '';
            count.textContent = questionBank.length;

            if (questionBank.length === 0) {
                list.innerHTML = `<p class="text-gray-500 italic">Bank Soal kosong. Silakan tambahkan soal baru.</p>`;
                return;
            }

            questionBank.forEach((q, index) => {
                const returnToExam = document.getElementById('bank-return-screen').value === 'exam-creator-screen';
                
                const item = document.createElement('div');
                item.className = 'dark-card p-4 flex justify-between items-start border-l-4 border-cyan-500';
                
                const truncatedText = q.text.substring(0, 100) + (q.text.length > 100 ? '...' : '');

                item.innerHTML = `
                    <div class="flex-grow mr-4 overflow-hidden">
                        <p class="text-sm font-semibold text-gray-400 mb-1">[${q.type.toUpperCase()}] ${q.tag_topik ? `(${q.tag_topik})` : ''} Soal ${index + 1}</p>
                        <p class="text-white text-base break-words">${truncatedText}</p>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0">
                        <button onclick="previewQuestion('${q.id}')" class="text-indigo-400 hover:text-indigo-500" title="Pratinjau Soal">👁️</button>
                        ${returnToExam ? `<button onclick="useQuestionFromBank('${q.id}')" class="text-teal-400 hover:text-teal-500" title="Gunakan di Ujian">➕</button>` : ''}
                        <button onclick="editQuestion('${q.id}', 'bank')" class="text-blue-400 hover:text-blue-500" title="Edit Soal">✏️</button>
                        <button onclick="deleteFromQuestionBank('${q.id}')" class="text-red-400 hover:text-red-500" title="Hapus Permanen">🗑️</button>
                    </div>
                `;
                list.appendChild(item);
            });
            
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise([list]);
            }
        }

        function deleteFromQuestionBank(id) {
            showConfirm("Yakin ingin menghapus soal ini dari Bank Soal?", () => {
                questionBank = questionBank.filter(q => q.id !== id);
                saveQuestionBank();
            }, null, true);
        }

        function exportBankToJSON() {
            if (questionBank.length === 0) {
                showConfirm("Bank Soal kosong, tidak ada data untuk diekspor.", null, null, true);
                return;
            }
            const dataStr = JSON.stringify(questionBank, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'bank_soal.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importBankFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        showConfirm(`Data ini berisi ${importedData.length} soal. Apakah Anda ingin menggabungkannya dengan Bank Soal yang sudah ada?`, () => {
                            questionBank = questionBank.concat(importedData);
                            saveQuestionBank();
                            showConfirm(`Berhasil mengimpor ${importedData.length} soal.`, null, null, false);
                        }, null);
                    } else {
                        throw new Error("Format file JSON tidak valid (bukan array soal).");
                    }
                } catch (error) {
                    showConfirm(`Gagal mengimpor file: ${error.message}`, null, null, true);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function renderExamQuestionList() {
            const list = document.getElementById('exam-question-list');
            const count = document.getElementById('exam-question-count');
            list.innerHTML = '';
            count.textContent = examData.questions.length;
            
            document.getElementById('exam-title-input').value = examData.title;
            document.getElementById('exam-duration-input').value = examData.duration;
            document.getElementById('exam-password-input').value = examData.password;
            document.getElementById('exam-code-lock-input').value = examData.unlockCode;
            document.getElementById('exam-strikes-input').value = examData.maxStrikes;
            document.getElementById('exam-shuffle-q-input').checked = examData.shuffleQuestions;
            document.getElementById('exam-shuffle-o-input').checked = examData.shuffleOptions;
            document.getElementById('exam-show-score-input').checked = examData.showScore;
            document.getElementById('exam-limit-attempts-input').checked = examData.limitAttempts;
            document.getElementById('exam-allowed-classes-input').value = examData.allowedClasses.join(', ');
            document.getElementById('exam-show-review-input').checked = examData.showReview;
            document.getElementById('exam-show-pembahasan-input').checked = examData.showPembahasan;

            if (examData.questions.length === 0) {
                list.innerHTML = `<p class="text-gray-500 italic">Belum ada soal. Silakan tambahkan soal di atas.</p>`;
                return;
            }

            examData.questions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'dark-card p-4 flex justify-between items-start border-l-4 border-pink-500';
                const answerDisplay = Array.isArray(q.answer) ? q.answer.join(', ') : q.answer;
                const truncatedText = q.text.substring(0, 100) + (q.text.length > 100 ? '...' : '');

                item.innerHTML = `
                    <div class="flex-grow mr-4 overflow-hidden">
                        <p class="text-sm font-semibold text-gray-400 mb-1">[${q.type.toUpperCase()}] Soal ${index + 1}</p>
                        <p class="text-white text-base break-words">${truncatedText}</p>
                        <p class="text-green-300 text-sm mt-1">Kunci: ${answerDisplay}</p>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0">
                        <button onclick="editQuestion('${q.id}', 'exam')" class="text-blue-400 hover:text-blue-500" title="Edit Soal">✏️</button>
                        <button onclick="deleteQuestionFromExam('${q.id}')" class="text-red-400 hover:text-red-500" title="Hapus dari Ujian">🗑️</button>
                    </div>
                `;
                list.appendChild(item);
            });
            
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise([list]);
            }
        }

        function deleteQuestionFromExam(id) {
            showConfirm("Yakin ingin menghapus soal ini dari Ujian?", () => {
                examData.questions = examData.questions.filter(q => q.id !== id);
                renderExamQuestionList();
            }, null, true);
        }

        function useQuestionFromBank(id) {
            const question = questionBank.find(q => q.id === id);
            if (question) {
                const newId = Date.now().toString() + Math.random().toString(36).substring(2, 5);
                const newQuestion = JSON.parse(JSON.stringify(question));
                newQuestion.id = newId;
                examData.questions.push(newQuestion);
                renderExamQuestionList();
                showConfirm("Soal berhasil ditambahkan ke Ujian.", null, null, false);
            }
        }

        function useAllQuestionsFromBank() {
            showConfirm(`Anda yakin ingin menambahkan ${questionBank.length} soal dari Bank ke Ujian saat ini? Soal yang sudah ada akan diganti.`, () => {
                examData.questions = [];
                questionBank.forEach(q => {
                    const newId = Date.now().toString() + Math.random().toString(36).substring(2, 5);
                    const newQuestion = JSON.parse(JSON.stringify(q));
                    newQuestion.id = newId;
                    examData.questions.push(newQuestion);
                });
                renderExamQuestionList();
                showScreen('exam-creator-screen');
                showConfirm("Semua soal dari Bank berhasil ditambahkan ke Ujian.", null, null, false);
            }, null);
        }

        // --- SCORE RECAP LOGIC ---
        
        function loadScoreRecap() {
            try {
                const savedScores = localStorage.getItem(KEY_PREFIX + SCORE_COLLECTION);
                scoreRecap = savedScores ? JSON.parse(savedScores) : [];
                renderScoreAnalysis(currentAnalysisFilter);
            } catch (e) {
                console.error("Gagal memuat Rekap Nilai:", e);
                scoreRecap = [];
            }
        }

        function saveScoreRecap() {
            try {
                localStorage.setItem(KEY_PREFIX + SCORE_COLLECTION, JSON.stringify(scoreRecap));
                renderScoreAnalysis(currentAnalysisFilter);
            } catch (e) {
                console.error("Gagal menyimpan Rekap Nilai:", e);
            }
        }
        
        function renderScoreAnalysis(filterClass = 'all') {
            const count = document.getElementById('recap-entry-count');
            const container = document.getElementById('score-analysis-container');
            const classFilter = document.getElementById('analysis-class-filter');
            
            const classes = [...new Set(scoreRecap.map(r => r.studentClass))];
            
            classFilter.innerHTML = `<option value="all">Semua Kelas</option>` + 
                classes.map(c => `<option value="${c}" ${c === filterClass ? 'selected' : ''}>${c}</option>`).join('');

            const filteredRecap = scoreRecap.filter(r => filterClass === 'all' || r.studentClass === filterClass);
            
            count.textContent = filteredRecap.length;
            container.innerHTML = filteredRecap.length === 0 
                ? `<p class="text-gray-500 italic">Belum ada hasil ujian yang tersimpan.</p>` 
                : `<table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800"><tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase">Nama (NIS)</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase">Ujian</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase">Kelas</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase">Nilai</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase">Aksi</th>
                    </tr></thead>
                    <tbody class="divide-y divide-gray-700">${filteredRecap.map(r => `
                        <tr class="${r.needsManualReview ? 'bg-yellow-900 bg-opacity-30' : ''}">
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-white">${r.studentName} (${r.studentId.split('_')[1]})</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400">${r.examTitle}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400">${r.studentClass}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-bold ${r.needsManualReview ? 'text-yellow-400' : 'text-green-400'}">${r.score ?? 'Review'}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-red-400 hover:text-red-600 cursor-pointer" onclick="deleteScoreEntry('${r.studentId}', '${r.examTitle}')">🗑️</td>
                        </tr>
                    `).join('')}</tbody>
                </table>`;
            currentAnalysisFilter = filterClass;
        }

        function deleteScoreEntry(studentId, examTitle) {
             showConfirm("Yakin ingin menghapus hasil ujian ini?", () => {
                 scoreRecap = scoreRecap.filter(r => !(r.studentId === studentId && r.examTitle === examTitle));
                 saveScoreRecap();
             }, null, true);
        }

        function exportScoresToCSV() {
            if (scoreRecap.length === 0) {
                showConfirm("Tidak ada data nilai untuk diexport.", null, null, true);
                return;
            }
            const header = ["Nama", "NIS", "Kelas", "Ujian", "Nilai", "Perlu Review", "Waktu Mulai", "Waktu Selesai"];
            const csv = scoreRecap.map(r => [
                `"${r.studentName}"`,
                r.studentId.split('_')[1],
                r.studentClass,
                `"${r.examTitle}"`,
                r.score,
                r.needsManualReview ? 'Ya' : 'Tidak',
                new Date(r.startTime).toLocaleString(),
                r.finishTime ? new Date(r.finishTime).toLocaleString() : 'N/A'
            ].join(','));

            const csvContent = "data:text/csv;charset=utf-8," + [header.join(','), ...csv].join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "rekap_nilai_ujian.csv");
            link.click();
        }

        function clearScoreRecap() {
            showConfirm("Anda yakin ingin menghapus SEMUA rekap nilai?", () => {
                scoreRecap = [];
                saveScoreRecap();
                showConfirm("Semua rekap nilai telah dihapus.", null, null, false);
            }, null, true);
        }
        
        // --- STUDENT MANAGER FUNCTIONS ---
        
        async function loadStudents() {
            if (!isAuthReady) {
                console.warn("loadStudents() dipanggil sebelum autentikasi siap. Menunggu...");
                document.getElementById('student-list-container').innerHTML = `<p class="text-yellow-400 italic">Menunggu autentikasi server...</p>`;
                return;
            }
            if (!db) {
                document.getElementById('student-list-container').innerHTML = `<p class="text-red-400">Gagal terhubung ke Firebase. Manajemen siswa memerlukan koneksi server.</p>`;
                return;
            }
            
            try {
                const studentRef = db.collection(STUDENT_COLLECTION);
                const snapshot = await studentRef.get();
                
                studentsData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Menggunakan ID dokumen sebagai NIS/ID
                    return {
                        id: doc.id,
                        studentName: data.name || 'Nama tidak ada',
                        studentId: doc.id,
                        studentClass: data.kelas || 'Kelas tidak ada',
                        photoUrl: data.photoUrl || null // Muat URL Foto
                    };
                });

                // Update filter options
                const classes = [...new Set(studentsData.map(s => s.studentClass))].sort();
                const filterSelect = document.getElementById('student-class-filter');
                const currentFilter = filterSelect.value;
                
                filterSelect.innerHTML = '<option value="all">Filter Kelas (Semua)</option>' +
                    classes.map(c => `<option value="${c}" ${c === currentFilter ? 'selected' : ''}>${c}</option>`).join('');

                renderStudentList(); // Panggil render dengan filter default

            } catch (error) {
                console.error("Gagal memuat data siswa:", error);
                
                var errorMessage = `Error memuat data: ${error.message}`;
                 if (error.code === 'permission-denied') {
                     errorMessage = "Error memuat data: Izin ditolak. Pastikan Security Rules Firebase Anda sudah benar.";
                 } else if (error.message && error.message.includes('A network error')) {
                     errorMessage = "Error memuat data: Masalah koneksi jaringan.";
                 }

                document.getElementById('student-list-container').innerHTML = `<p class="text-red-400">${errorMessage}</p>`;
            }
        }
        
        function sortStudentList(key) {
            // Toggle direction if the same key is clicked
            if (currentStudentSortKey === key) {
                currentStudentSortDirection = currentStudentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentStudentSortKey = key;
                currentStudentSortDirection = 'asc';
            }
            renderStudentList();
        }

        function renderStudentList() {
            const container = document.getElementById('student-list-container');
            const count = document.getElementById('student-count');
            const filterClass = document.getElementById('student-class-filter').value;

            // 1. Apply Filter
            let filteredStudents = studentsData;
            if (filterClass !== 'all') {
                filteredStudents = studentsData.filter(s => s.studentClass === filterClass);
            }
            
            // 2. Apply Sort
            filteredStudents.sort((a, b) => {
                const valA = a[currentStudentSortKey].toUpperCase();
                const valB = b[currentStudentSortKey].toUpperCase();
                
                let comparison = 0;
                if (valA > valB) {
                    comparison = 1;
                } else if (valA < valB) {
                    comparison = -1;
                }
                
                return currentStudentSortDirection === 'asc' ? comparison : comparison * -1;
            });
            
            // 3. Update UI
            count.textContent = filteredStudents.length;
            const sortIndicator = document.getElementById('sort-indicator');
            sortIndicator.textContent = currentStudentSortDirection === 'asc' ? '⬆️' : '⬇️';


            if (filteredStudents.length === 0 && isOnline) { 
                container.innerHTML = `<p class="text-gray-500 italic">Belum ada siswa yang terdaftar di database online.</p>`;
                return;
            } else if (filteredStudents.length === 0) {
                 container.innerHTML = `<p class="text-gray-500 italic">Tidak ada siswa yang ditemukan di kelas ini.</p>`;
                 return;
            }
            
            container.innerHTML = `<table class="student-table">
                <thead>
                    <tr>
                        <th>Nama Lengkap</th>
                        <th>NIS/ID</th>
                        <th>Kelas</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredStudents.map(s => `
                        <tr>
                            <td class="text-white flex items-center">
                                <img src="${s.photoUrl || 'https://placehold.co/30x30/374151/E5E7EB?text=F'}" onerror="this.onerror=null;this.src='https://placehold.co/30x30/374151/E5E7EB?text=F';" class="w-8 h-8 rounded-full object-cover mr-3 border border-gray-600">
                                ${s.studentName}
                            </td>
                            <td class="text-gray-400">${s.studentId}</td>
                            <td class="text-gray-400">${s.studentClass}</td>
                            <td class="text-red-400 hover:text-red-600 cursor-pointer" onclick="deleteStudentOnline('${s.id}', '${s.studentName}')">🗑️</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
        }

        async function addStudentOnline() {
            if (!db || !auth.currentUser) {
                showConfirm("Gagal: Koneksi ke server tidak stabil. Coba periksa koneksi internet Anda.", null, null, true);
                return;
            }

            const name = document.getElementById('new-student-name').value.trim();
            const nis = document.getElementById('new-student-nis').value.trim();
            const studentClass = document.getElementById('new-student-class').value.trim();
            const photoFile = document.getElementById('new-student-photo-upload').files[0]; 
            
            if (!name || !nis || !studentClass) {
                showConfirm("Nama, NIS, dan Kelas harus diisi.", null, null, true);
                return;
            }
            
            const studentDocId = nis;
            let photoBase64 = null;

            if (photoFile) {
                try {
                    photoBase64 = await readFileAsBase64(photoFile);
                } catch (e) {
                    showConfirm(`Gagal mengolah file foto: ${e.message}`, null, null, true);
                    return;
                }
            }

            try {
                const studentRef = db.collection(STUDENT_COLLECTION).doc(studentDocId);
                await studentRef.set({
                    name: name,
                    kelas: studentClass,
                    photoUrl: photoBase64 || null, // Simpan BASE64 Foto
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showConfirm(`✅ Siswa ${name} berhasil ditambahkan!`, null, null, false);
                
                document.getElementById('new-student-name').value = '';
                document.getElementById('new-student-nis').value = '';
                document.getElementById('new-student-class').value = '';
                removeImage('new-student-photo-upload', 'new-student-photo-preview');

                loadStudents();
            } catch (error) {
                console.error("Gagal menambahkan siswa:", error);
                
                var errorMessage = `Gagal menambahkan siswa: ${error.message}`;
                if (error.code === 'permission-denied') {
                    errorMessage = "Gagal menambahkan siswa: Izin Firebase ditolak. Periksa otorisasi Guru.";
                }

                showConfirm(errorMessage, null, null, true);
            }
        }
        
        async function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        async function deleteStudentOnline(docId, studentName) {
            if (!db) return;
            
            showConfirm(`Yakin ingin menghapus siswa ${studentName} secara permanen dari database?`, async () => {
                try {
                    await db.collection(STUDENT_COLLECTION).doc(docId).delete();
                    showConfirm(`✅ Siswa ${studentName} berhasil dihapus.`, null, null, false);
                    loadStudents();
                } catch (error) {
                    console.error("Gagal menghapus siswa:", error);
                    
                    var errorMessage = `Gagal menghapus siswa: ${error.message}`;
                    if (error.code === 'permission-denied') {
                        errorMessage = "Gagal menghapus siswa: Izin Firebase ditolak. Periksa otorisasi Guru.";
                    }
                    
                    showConfirm(errorMessage, null, null, true);
                }
            }, null, true);
        }

        async function deleteAllStudents() {
            if (!db) return;

            showConfirm(`PERINGATAN: Anda akan menghapus SEMUA (${studentsData.length}) data siswa dari database online. Aksi ini tidak dapat dibatalkan. Yakin ingin melanjutkan?`, async () => {
                try {
                    const studentRef = db.collection(STUDENT_COLLECTION);
                    const snapshot = await studentRef.get();
                    
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    
                    showConfirm(`✅ Berhasil menghapus semua data siswa.`, null, null, false);
                    loadStudents(); // Refresh the list
                } catch (error) {
                    console.error("Gagal menghapus semua siswa:", error);
                    showConfirm(`Gagal menghapus siswa: ${error.message}`, null, null, true);
                }
            }, null, true);
        }

        async function importFromExcel() {
            if (!db) return;

            const data = document.getElementById('excel-import-data').value.trim();
            if (!data) {
                showConfirm("Kotak data impor masih kosong. Silakan salin data dari Excel dan tempel di sana.", null, null, true);
                return;
            }

            const rows = data.split('\n').filter(row => row.trim() !== '');
            if (rows.length === 0) {
                showConfirm("Tidak ada data valid yang ditemukan untuk diimpor.", null, null, true);
                return;
            }

            showConfirm(`Anda akan mengimpor ${rows.length} data siswa. Data dengan NIS/ID yang sama akan ditimpa. Lanjutkan?`, async () => {
                try {
                    const batch = db.batch();
                    let importedCount = 0;

                    rows.forEach(row => {
                        const columns = row.split('\t');
                        // Mendukung 3 atau 4 kolom
                        if (columns.length >= 3) {
                            const nis = columns[0].trim();
                            const name = columns[1].trim();
                            const studentClass = columns[2].trim();
                            const photoUrl = (columns[3] || '').trim(); // Kolom ke-4 opsional

                            if (nis && name && studentClass) {
                                const docRef = db.collection(STUDENT_COLLECTION).doc(nis);
                                batch.set(docRef, { name: name, kelas: studentClass, photoUrl: photoUrl || null });
                                importedCount++;
                            }
                        }
                    });

                    if (importedCount === 0) {
                        showConfirm("Gagal mengimpor. Pastikan format data Anda benar: NIS [tab] NAMA [tab] KELAS ([tab] URL_FOTO opsional).", null, null, true);
                        return;
                    }

                    await batch.commit();
                    document.getElementById('excel-import-data').value = '';
                    showConfirm(`✅ Berhasil mengimpor ${importedCount} siswa!`, null, null, false);
                    loadStudents();

                } catch (error) {
                    console.error("Gagal impor massal:", error);
                    showConfirm(`Gagal mengimpor: ${error.message}`, null, null, true);
                }
            }, null);
        }


        // --- STUDENT EXAM FLOW LOGIC ---

        async function findStudentByNis() {
            if (!isAuthReady) {
                showConfirm("Server autentikasi belum siap. Mohon tunggu sesaat dan coba lagi.", null, null, true);
                return;
            }
            const nis = document.getElementById('student-id-input').value.trim();
            if (!nis) {
                showConfirm("NIS tidak boleh kosong.", null, null, true);
                return;
            }

            const findBtn = document.getElementById('find-student-btn');
            findBtn.disabled = true;
            findBtn.textContent = "Mencari...";

            try {
                const studentRef = db.collection(STUDENT_COLLECTION).doc(nis);
                const doc = await studentRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    foundStudentData = { name: data.name, nis: nis, kelas: data.kelas };
                    
                    document.getElementById('confirm-student-name').textContent = data.name;
                    document.getElementById('confirm-student-class').textContent = data.kelas;

                    document.getElementById('student-find-step').classList.add('hidden');
                    document.getElementById('student-confirm-step').classList.remove('hidden');

                } else {
                    showConfirm(`Siswa dengan NIS ${nis} tidak ditemukan di database. Pastikan NIS benar dan Anda terhubung ke internet.`, null, null, true);
                }
            } catch (error) {
                console.error("Error finding student:", error);
                showConfirm(`Gagal mencari data siswa: ${error.message}`, null, null, true);
            } finally {
                findBtn.disabled = false;
                findBtn.textContent = "Cari";
            }
        }

        function resetStudentFind() {
            foundStudentData = null;
            document.getElementById('student-id-input').value = '';
            document.getElementById('exam-code-input').value = '';
            document.getElementById('student-find-step').classList.remove('hidden');
            document.getElementById('student-confirm-step').classList.add('hidden');
        }


        function startExamFlow() {
            const examCode = document.getElementById('exam-code-input').value.trim().toUpperCase();
            
            if (!foundStudentData) {
                showConfirm("Silakan cari data siswa Anda terlebih dahulu menggunakan NIS.", null, null, true);
                return;
            }
            
            if (examCode) {
                startHybridExam();
            } else {
                startExam();
            }
        }

        async function startExam() {
            const { name, nis, kelas } = foundStudentData;
            
            if (examData.questions.length === 0) {
                showConfirm("Soal ujian belum disiapkan di Bank Lokal. Silakan minta Guru untuk menyiapkan soal.", null, null, true);
                return;
            }
            
            // Simpan kunci jawaban ke local storage siswa agar bisa direview
            saveAnswerKeyToLocal(examData);

            if (examData.limitAttempts) {
                const studentId = getStudentIdentifier(name, nis, kelas);
                const hasTaken = scoreRecap.some(score => score.studentId === studentId && score.examTitle === examData.title);
                
                if (hasTaken) {
                    showConfirm("Anda sudah pernah menyelesaikan ujian ini. Silakan hubungi Guru jika ingin mengulang.", null, null, true);
                    return;
                }
            }

            showConfirm(`Anda akan memulai ujian: ${examData.title} selama ${examData.duration} menit. Lanjutkan? (Mode Lokal)`, () => {
                studentExamData = {
                    studentId: getStudentIdentifier(name, nis, kelas),
                    studentName: name,
                    studentClass: kelas,
                    examId: examData.examId || 'OFFLINE_EXAM_' + Date.now(),
                    examTitle: examData.title,
                    startTime: Date.now(),
                    duration: examData.duration,
                    questions: JSON.parse(JSON.stringify(examData.questions)),
                    answers: {},
                    isLocked: false,
                    strikes: 0,
                    synced: true, // Ujian offline tidak perlu sync
                    isFinalChance: false // DEFAULT
                };
                
                if (examData.shuffleQuestions) { shuffleArray(studentExamData.questions); }
                if (examData.shuffleOptions) {
                    studentExamData.questions.forEach(q => {
                        if (q.options && q.options.length > 0 && (q.type === 'mc' || q.type === 'mc-complex')) {
                            shuffleArray(q.options);
                        }
                    });
                }
                
                quizState = {
                    currentQIndex: 0,
                    answers: studentExamData.answers,
                    totalSeconds: examData.duration * 60,
                    timeLeft: examData.duration * 60,
                    timer: null,
                    strikes: 0,
                    isLocked: false,
                };

                showScreen('student-exam-screen');
                renderQuizQuestions();
                startQuizTimer();
                // TIDAK ADA LIVE STATUS UNTUK MODE OFFLINE
            }, null);
        }

        async function startHybridExam() {
            const examCode = document.getElementById('exam-code-input').value.trim().toUpperCase();
            const { name, nis, kelas } = foundStudentData;
            
            if (!db) {
                showConfirm("Koneksi ke server tidak tersedia. Silakan periksa koneksi internet Anda.", null, null, true);
                return;
            }
            
            try {
                const examRef = db.collection(EXAM_COLLECTION).doc(examCode);
                const doc = await examRef.get();

                if (!doc.exists) {
                    showConfirm("Kode Ujian tidak ditemukan. Pastikan kode sudah benar.", null, null, true);
                    return;
                }

                const onlineExamData = doc.data();
                
                // FITUR BARU: Validasi Kelas
                const studentClassUpper = kelas.toUpperCase();
                if (onlineExamData.allowedClasses && onlineExamData.allowedClasses.length > 0) {
                    if (!onlineExamData.allowedClasses.includes(studentClassUpper)) {
                        showConfirm(`Ujian ini tidak ditujukan untuk kelas Anda (${kelas}). Silakan hubungi guru.`, null, null, true);
                        return;
                    }
                }
                
                if (onlineExamData.limitAttempts) {
                    const studentId = getStudentIdentifier(name, nis, kelas);
                    const scorePath = `${EXAM_COLLECTION}/${examCode}/${SCORE_COLLECTION}`;
                    const scoreDocRef = db.collection(scorePath).doc(studentId);
                    const scoreDoc = await scoreDocRef.get();

                    if (scoreDoc.exists) {
                        showConfirm("Anda sudah pernah menyelesaikan ujian ini. Silakan hubungi Guru jika ingin mengulang.", null, null, true);
                        return;
                    }
                }
                
                examData = onlineExamData; 
                // Simpan kunci jawaban ke local storage siswa agar bisa direview
                saveAnswerKeyToLocal(onlineExamData);
                
                // Cek status live siswa (untuk melihat apakah dia dalam Final Chance)
                let isFinalChance = false;
                let initialStrikes = 0;

                const liveRef = db.collection(EXAM_COLLECTION).doc(examCode).collection(LIVE_MONITORING_COLLECTION).doc(getStudentIdentifier(name, nis, kelas));
                const liveDoc = await liveRef.get();
                if (liveDoc.exists) {
                    const liveData = liveDoc.data();
                    if (liveData.isFinalChance) {
                        isFinalChance = true;
                        initialStrikes = liveData.strikes; // Ambil strikes terakhir (yang harusnya 0 jika baru direset)
                    }
                }
                
                showConfirm(`Anda akan memulai ujian: ${onlineExamData.title} (Online) selama ${onlineExamData.duration} menit. Lanjutkan? ${isFinalChance ? '(KESEMPATAN TERAKHIR)' : ''}`, () => {
                    studentExamData = {
                        studentId: getStudentIdentifier(name, nis, kelas),
                        studentName: name,
                        studentClass: kelas,
                        examId: onlineExamData.examId,
                        examTitle: onlineExamData.title,
                        startTime: Date.now(),
                        duration: onlineExamData.duration,
                        questions: JSON.parse(JSON.stringify(onlineExamData.questions)),
                        answers: {},
                        isLocked: false,
                        strikes: initialStrikes,
                        synced: false, // Ujian online perlu sync
                        isFinalChance: isFinalChance // FITUR BARU: Simpan status Final Chance
                    };
                    
                    if (onlineExamData.shuffleQuestions) { shuffleArray(studentExamData.questions); }
                    if (onlineExamData.shuffleOptions) {
                        studentExamData.questions.forEach(q => {
                            if (q.options && q.options.length > 0 && (q.type === 'mc' || q.type === 'mc-complex')) {
                                shuffleArray(q.options);
                            }
                        });
                    }
                    
                    quizState = {
                        currentQIndex: 0,
                        answers: studentExamData.answers,
                        totalSeconds: onlineExamData.duration * 60,
                        timeLeft: onlineExamData.duration * 60,
                        timer: null,
                        strikes: initialStrikes,
                        isLocked: false,
                    };

                    showScreen('student-exam-screen');
                    renderQuizQuestions();
                    startQuizTimer();
                    // MEMULAI LIVE STATUS UNTUK UJIAN ONLINE
                    startLiveStatus();
                }, null);

            } catch (error) {
                console.error("Error fetching online exam:", error);
                showConfirm("Gagal mengambil data ujian dari server. Coba periksa koneksi internet Anda.", null, null, true);
            }
        }

        function startQuizTimer() {
            clearInterval(quizState.timer);
            const timerDisplay = document.getElementById('quiz-timer');

            const countdown = () => {
                if (quizState.timeLeft <= 0) {
                    clearInterval(quizState.timer);
                    timerDisplay.textContent = "00:00";
                    showConfirm("Waktu ujian telah habis! Jawaban Anda akan otomatis dikirim.", () => submitExam(true), null, true);
                    return;
                }

                quizState.timeLeft--;
                const minutes = String(Math.floor(quizState.timeLeft / 60)).padStart(2, '0');
                const seconds = String(quizState.timeLeft % 60).padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
                
                if (quizState.timeLeft < 60) {
                    timerDisplay.parentNode.classList.add('text-red-500');
                }
            };

            quizState.timer = setInterval(countdown, 1000);
            countdown();
        }

        function submitExam(isAutoSubmit = false) {
            const currentQ = studentExamData.questions[quizState.currentQIndex];
            if (currentQ && (currentQ.type === 'essay' || currentQ.type === 'essay-complex')) {
                // Fungsi saveEssayAnswer sudah menyimpan secara real-time
                // Tapi kita panggil lagi untuk memastikan data terakhir tersimpan
                saveEssayAnswer(document.getElementById('essay-answer-input').value, currentQ.id);
            }

            const unansweredCount = studentExamData.questions.filter(q => {
                const answer = quizState.answers[q.id];
                if (q.type === 'mc-complex') {
                    return !Array.isArray(answer) || answer.length === 0;
                }
                if (q.type === 'essay' || q.type === 'essay-complex') {
                    return !answer || (!answer.text && !answer.image);
                }
                return !answer;
            }).length;
            
            if (!isAutoSubmit && unansweredCount > 0) {
                showConfirm(`Anda memiliki ${unansweredCount} soal yang belum dijawab. Yakin ingin mengakhiri ujian?`, () => {
                    finalizeSubmission();
                }, null, true);
                return;
            }
            
            finalizeSubmission();
        }

        function finalizeSubmission() {
            clearInterval(quizState.timer);
            studentExamData.finishTime = Date.now();
            studentExamData.answers = quizState.answers;
            
            const result = gradeStudentAnswerOffline(studentExamData);
            studentExamData.score = result.score;
            studentExamData.correctCount = result.correctCount;
            studentExamData.needsManualReview = result.needsManualReview;

            // HENTIKAN LIVE STATUS DAN HAPUS DATA LIVE
            if (!studentExamData.examId.startsWith('OFFLINE_EXAM_')) {
                stopLiveStatus(true);
                studentExamData.synced = false; // Akan disinkronkan oleh syncOfflineScores
            } else {
                studentExamData.synced = true;
            }

            // Simpan ke rekap lokal (offline)
            scoreRecap.push(studentExamData);
            saveScoreRecap();
            
            // Coba kirim ke server (online)
            syncOfflineScores();

            document.getElementById('result-student-name').textContent = studentExamData.studentName;
            document.getElementById('result-exam-title').textContent = studentExamData.examTitle;

            if (examData.showScore) {
                document.getElementById('result-score').textContent = studentExamData.score;
                if (studentExamData.needsManualReview) {
                    document.getElementById('result-note').textContent = "Nilai sementara. Perlu review manual untuk soal esai.";
                } else {
                    document.getElementById('result-note').textContent = `Anda menjawab ${studentExamData.correctCount} dari ${studentExamData.questions.length} soal dengan benar.`;
                }
            } else {
                document.getElementById('result-score').textContent = "---";
                document.getElementById('result-note').textContent = "Nilai akan diumumkan oleh Guru. Terima kasih sudah mengerjakan ujian!";
            }
            
            // Tombol Unduh Jawaban (Dihapus)
            document.getElementById('export-answer-container').innerHTML = '';

            // Tampilkan tombol review jika diizinkan
            if (examData.showReview) {
                document.getElementById('review-exam-btn').classList.remove('hidden');
            } else {
                document.getElementById('review-exam-btn').classList.add('hidden');
            }
            
            showScreen('student-result-screen');
        }

        function gradeStudentAnswerOffline(examSubmission) {
            let correctCount = 0;
            let needsManualReview = false;
            const totalQuestions = examSubmission.questions.length;
            
            examSubmission.questions.forEach(q => {
                let studentAnswer = examSubmission.answers[q.id];
                let isCorrect = false;

                if (q.type === 'mc') {
                    isCorrect = studentAnswer === q.answer;
                } else if (q.type === 'mc-complex') {
                    const key = q.answer; 
                    const answer = Array.isArray(studentAnswer) ? studentAnswer : [];
                    isCorrect = (key.sort().join(',') === answer.sort().join(','));
                } else if (q.type === 'essay-complex') {
                    needsManualReview = true;
                    isCorrect = false; // Selalu manual
                } else if (q.type === 'essay') {
                    const sAnswerText = (studentAnswer && studentAnswer.text) ? studentAnswer.text.trim().toLowerCase() : '';
                    const cAnswer = (q.answer || '').trim().toLowerCase();
                    if (sAnswerText !== '' && sAnswerText === cAnswer) {
                        isCorrect = true;
                    } else if (studentAnswer && studentAnswer.image) {
                        needsManualReview = true; // Jika ada gambar, perlu review
                        isCorrect = false;
                    } else if (sAnswerText !== '') {
                        needsManualReview = true; // Jika jawaban teks tidak cocok, perlu review
                        isCorrect = false;
                    }
                } else if (q.type === 'bs') {
                    isCorrect = studentAnswer === q.answer;
                }
                
                if (isCorrect) correctCount++;
            });

            const score = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;
            
            return { score, correctCount, needsManualReview };
        }

        function selectAnswer(questionId, answerLabel) {
            const q = studentExamData.questions.find(q => q.id === questionId);
            
            if (studentExamData.isLocked) return;

            if (q.type === 'mc') {
                quizState.answers[questionId] = (quizState.answers[questionId] === answerLabel) ? null : answerLabel;
            } else if (q.type === 'mc-complex') {
                let currentAnswers = Array.isArray(quizState.answers[questionId]) ? quizState.answers[questionId] : [];
                const index = currentAnswers.indexOf(answerLabel);

                if (index > -1) {
                    currentAnswers.splice(index, 1);
                } else {
                    currentAnswers.push(answerLabel);
                }
                quizState.answers[questionId] = currentAnswers.sort();
            }
            
            renderQuizQuestions();
        }

        function selectBsAnswer(questionId, statementIndex, value) {
            if (studentExamData.isLocked) return;

            const q = studentExamData.questions.find(q => q.id === questionId);
            let currentBsAnswer = quizState.answers[questionId] || new Array(q.options.length).fill('');
            
            if (typeof currentBsAnswer === 'string') {
                currentBsAnswer = currentBsAnswer.split('');
            }

            currentBsAnswer[statementIndex] = value;
            quizState.answers[questionId] = currentBsAnswer.join('');

            renderQuizQuestions();
        }

        // --- FUNGSI BARU UNTUK JAWABAN ESAI (Teks dan Gambar) ---
        const saveEssayAnswerDebounced = debounce((value, qId) => {
            if (quizState.isLocked) return;
            let answer = quizState.answers[qId] || { text: '', image: null };
            answer.text = value;
            quizState.answers[qId] = answer;
            // Kirim status live setiap kali jawaban diubah
            sendLiveStatus(true); 
        }, 1000); 

        function saveEssayAnswer(value, qId) {
            saveEssayAnswerDebounced(value, qId);
        }

        function saveEssayImage(fileInput, qId) {
            if (quizState.isLocked) return;
            const file = fileInput.files[0];
            const previewElement = document.getElementById(`essay-image-preview`);

            if (!file) {
                let answer = quizState.answers[qId] || { text: '', image: null };
                answer.image = null;
                quizState.answers[qId] = answer;
                previewElement.classList.add('hidden');
                previewElement.src = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                let answer = quizState.answers[qId] || { text: '', image: null };
                answer.image = e.target.result;
                quizState.answers[qId] = answer;
                
                previewElement.src = e.target.result;
                previewElement.classList.remove('hidden');
                sendLiveStatus(true); // Kirim status live setelah gambar diupload
            };
            reader.readAsDataURL(file);
        }

        function renderQuizQuestions() {
            if (!studentExamData || studentExamData.questions.length === 0) return;

            const q = studentExamData.questions[quizState.currentQIndex];
            const qNumber = quizState.currentQIndex + 1;
            
            document.getElementById('current-question-number').textContent = qNumber;
            document.getElementById('total-questions').textContent = studentExamData.questions.length;
            
            const prevBtn = document.getElementById('prev-question-btn');
            const nextBtn = document.getElementById('next-question-btn');
            const finishBtn = document.getElementById('finish-exam-btn');

            if (studentExamData.isLocked) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
                finishBtn.textContent = '❌ Keluar & Kirim Jawaban';
            } else {
                prevBtn.classList.remove('hidden');
                prevBtn.disabled = quizState.currentQIndex === 0;
                nextBtn.disabled = quizState.currentQIndex === studentExamData.questions.length - 1;
                
                nextBtn.classList.toggle('hidden', quizState.currentQIndex === studentExamData.questions.length - 1);
                finishBtn.classList.toggle('hidden', quizState.currentQIndex !== studentExamData.questions.length - 1);
                finishBtn.textContent = '✅ Selesai';
            }
            
            document.getElementById('quiz-title').textContent = studentExamData.examTitle;
            document.getElementById('question-text').innerHTML = q.text;
            
            const imgDisplay = document.getElementById('question-image-display');
            if (q.image && q.image.startsWith('data:')) {
                imgDisplay.src = q.image;
                imgDisplay.classList.remove('hidden');
            } else {
                imgDisplay.classList.add('hidden');
            }

            const optionsContainer = document.getElementById('options-container');
            const essayContainer = document.getElementById('essay-input-container');
            const essayInput = document.getElementById('essay-answer-input');
            const essayImageContainer = document.getElementById('essay-image-upload-container');
            const essayImageUpload = document.getElementById('essay-image-upload');
            const essayImagePreview = document.getElementById('essay-image-preview');

            optionsContainer.innerHTML = '';
            optionsContainer.classList.add('hidden');
            essayContainer.classList.add('hidden');
            
            let studentAnswer = quizState.answers[q.id];

            if (q.type === 'mc' || q.type === 'mc-complex') {
                optionsContainer.classList.remove('hidden');
                let displayOptions = q.options;
                const isComplex = q.type === 'mc-complex';
                const selectedAnswers = isComplex ? (Array.isArray(studentAnswer) ? studentAnswer : []) : (studentAnswer || '');

                displayOptions.forEach((opt, index) => {
                    let isSelected = isComplex ? selectedAnswers.includes(opt.label) : selectedAnswers === opt.label;
                    const optionClass = isComplex ? 'mc-complex' : 'mc-single';
                    const label = String.fromCharCode(65 + index);
                    
                    const iconHtml = isComplex 
                        ? (isSelected ? '☑️' : '⬜')
                        : `<span class="w-6 h-6 flex items-center justify-center border rounded-full font-bold text-sm">${label}</span>`;

                    const optionHtml = `
                        <div id="option-${q.id}-${label}" 
                            class="quiz-option p-3 rounded-lg flex flex-col space-y-2 ${isSelected ? 'selected' : ''} ${optionClass} ${studentExamData.isLocked ? 'opacity-70 cursor-not-allowed' : ''}" 
                            data-label="${opt.label}"
                            onclick="${studentExamData.isLocked ? '' : `selectAnswer('${q.id}', '${opt.label}'); sendLiveStatus(true);`}">
                            
                            <div class="flex items-center space-x-3">
                                ${iconHtml}
                                <span class="flex-grow">${opt.text}</span>
                            </div>
                            ${opt.image ? `<img src="${opt.image}" class="option-image mt-2" alt="Option Image">` : ''}
                        </div>
                    `;
                    optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
                });

            } else if (q.type === 'essay' || q.type === 'essay-complex') {
                essayContainer.classList.remove('hidden');
                essayInput.value = (studentAnswer && studentAnswer.text) || '';
                essayInput.disabled = studentExamData.isLocked;
                essayInput.oninput = () => saveEssayAnswer(essayInput.value, q.id);

                if(q.type === 'essay-complex') {
                    essayImageContainer.classList.remove('hidden');
                    essayImageUpload.onchange = () => saveEssayImage(essayImageUpload, q.id);
                    if (studentAnswer && studentAnswer.image) {
                        essayImagePreview.src = studentAnswer.image;
                        essayImagePreview.classList.remove('hidden');
                    } else {
                        essayImagePreview.classList.add('hidden');
                        essayImagePreview.src = '';
                    }
                } else {
                    essayImageContainer.classList.add('hidden');
                }

            } else if (q.type === 'bs') {
                optionsContainer.classList.remove('hidden');
                const bsAnswers = (studentAnswer || '').split('');

                q.options.forEach((stmt, index) => {
                    const currentAnswer = bsAnswers[index] || '';
                    
                    optionsContainer.insertAdjacentHTML('beforeend', `
                        <div class="dark-card p-4 rounded-lg space-y-2 ${studentExamData.isLocked ? 'opacity-70' : ''}">
                            <p class="text-sm font-bold text-gray-400">Pernyataan ${index + 1}:</p>
                            
                            <div class="text-base">${stmt.text}</div>
                            ${stmt.image ? `<img src="${stmt.image}" class="option-image mt-2" alt="Statement Image">` : ''}

                            <div class="flex space-x-4 pt-2 border-t border-gray-700">
                                <button class="quiz-option py-1 px-3 rounded-lg text-sm ${currentAnswer === 'B' ? 'selected mc-single' : ''} ${studentExamData.isLocked ? 'cursor-not-allowed' : ''}" 
                                    onclick="${studentExamData.isLocked ? '' : `selectBsAnswer('${q.id}', ${index}, 'B'); sendLiveStatus(true);`}">Benar</button>
                                <button class="quiz-option py-1 px-3 rounded-lg text-sm ${currentAnswer === 'S' ? 'selected mc-single' : ''} ${studentExamData.isLocked ? 'cursor-not-allowed' : ''}" 
                                    onclick="${studentExamData.isLocked ? '' : `selectBsAnswer('${q.id}', ${index}, 'S'); sendLiveStatus(true);`}">Salah</button>
                                <button class="py-1 px-3 rounded-lg text-sm bg-red-800 hover:bg-red-700 ${studentExamData.isLocked ? 'cursor-not-allowed' : ''}" 
                                    onclick="${studentExamData.isLocked ? '' : `selectBsAnswer('${q.id}', ${index}, ''); sendLiveStatus(true);`}">Reset</button>
                            </div>
                        </div>
                    `);
                });
            }

            renderQuestionNavPanel();
            
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise([document.getElementById('question-area')]);
            }
            
            // Kirim status live setiap kali soal berubah
            if (currentScreen === 'student-exam-screen' && !studentExamData.examId.startsWith('OFFLINE_EXAM_')) {
                sendLiveStatus(true);
            }
        }

        // --- FUNGSI BARU: Membangun Layar Review ---
        function buildReviewScreen() {
            showScreen('student-review-screen');
            const container = document.getElementById('review-container');
            container.innerHTML = '<p class="text-lg text-yellow-400">Memuat tinjauan...</p>';
            let reviewHtml = '';

            const originalQuestions = {};
            // Cek kunci jawaban lokal (offline)
            const localKey = ANSWER_KEY_PREFIX + studentExamData.examId;
            const localData = localStorage.getItem(localKey);
            if (localData) {
                JSON.parse(localData).questions.forEach(q => {
                    originalQuestions[q.id] = q;
                });
            }

            studentExamData.questions.forEach((q, index) => {
                const originalQ = originalQuestions[q.id] || q; // Fallback ke data siswa jika kunci tidak ada
                const studentAnswer = studentExamData.answers[q.id];
                const correctAnswer = originalQ.answer;

                let answerHtml = '';
                let isStudentCorrect = false;

                if (q.type === 'mc' || q.type === 'mc-complex') {
                    const isComplex = q.type === 'mc-complex';
                    const correctAnswers = Array.isArray(correctAnswer) ? correctAnswer : [correctAnswer];
                    const studentAnswers = Array.isArray(studentAnswer) ? studentAnswer : [studentAnswer];

                    // Cek jawaban benar
                    if(isComplex) {
                        isStudentCorrect = correctAnswers.length === studentAnswers.length && correctAnswers.every(a => studentAnswers.includes(a));
                    } else {
                        isStudentCorrect = studentAnswers[0] === correctAnswers[0];
                    }

                    answerHtml += '<div class="space-y-2 mt-2">';
                    q.options.forEach(opt => {
                        const isCorrect = correctAnswers.includes(opt.label);
                        const isSelected = studentAnswers.includes(opt.label);
                        let borderColor = 'border-gray-600';
                        
                        if (isCorrect) borderColor = 'border-green-500';
                        else if (isSelected && !isCorrect) borderColor = 'border-red-500';

                        answerHtml += `
                            <div class="p-3 border-2 ${borderColor} rounded-lg ${isCorrect ? 'bg-green-900/30' : ''} ${isSelected && !isCorrect ? 'bg-red-900/30' : ''}">
                                <span class="font-bold ${isCorrect ? 'text-green-400' : ''} ${isSelected && !isCorrect ? 'text-red-400' : ''}">${opt.label}. ${opt.text}</span>
                                ${opt.image ? `<img src="${opt.image}" class="option-image">` : ''}
                            </div>
                        `;
                    });
                    answerHtml += '</div>';

                } else if (q.type === 'bs') {
                    const correctAnswers = (correctAnswer || '').split('');
                    const studentAnswers = (studentAnswer || '').split('');
                    isStudentCorrect = studentAnswer === correctAnswer;

                    answerHtml += '<div class="space-y-2 mt-2">';
                    q.options.forEach((stmt, i) => {
                        const isCorrect = correctAnswers[i] === studentAnswers[i];
                        const cAnsText = correctAnswers[i] === 'B' ? 'Benar' : 'Salah';
                        const sAnsText = studentAnswers[i] === 'B' ? 'Benar' : (studentAnswers[i] === 'S' ? 'Salah' : 'Kosong');
                        
                        answerHtml += `
                            <div class="p-3 border-2 ${isCorrect ? 'border-green-500 bg-green-900/30' : 'border-red-500 bg-red-900/30'} rounded-lg">
                                <p>${stmt.text}</p>
                                ${stmt.image ? `<img src="${stmt.image}" class="option-image">` : ''}
                                <p class="text-sm mt-2">Jawaban Anda: <span class="font-bold">${sAnsText}</span></p>
                                <p class="text-sm ${isCorrect ? 'text-green-400' : 'text-yellow-400'}">Kunci: <span class="font-bold">${cAnsText}</span></p>
                            </div>
                        `;
                    });
                    answerHtml += '</div>';
                
                } else if (q.type === 'essay' || q.type === 'essay-complex') {
                    const sAnswerText = (studentAnswer && studentAnswer.text) || '<i>(Tidak dijawab)</i>';
                    const sAnswerImage = (studentAnswer && studentAnswer.image) || null;
                    
                    answerHtml = `<div class="p-3 border border-gray-600 rounded-lg bg-gray-700 mt-2">
                        <p class="text-sm font-semibold text-gray-400">JAWABAN ANDA (Teks):</p>
                        <p>${sAnswerText}</p>
                        ${sAnswerImage ? `<p class="text-sm font-semibold text-gray-400 mt-2">JAWABAN ANDA (Gambar):</p><img src="${sAnswerImage}" class="option-image">` : ''}
                    </div>`;

                    if (q.type === 'essay') {
                        isStudentCorrect = sAnswerText.toLowerCase() === (correctAnswer || '').toLowerCase();
                        answerHtml += `<div class="p-3 border ${isStudentCorrect ? 'border-green-500 bg-green-900/30' : 'border-yellow-500 bg-yellow-900/30'} rounded-lg mt-2">
                            <p class="text-sm font-semibold ${isStudentCorrect ? 'text-green-400' : 'text-yellow-400'}">KUNCI JAWABAN SINGKAT:</p>
                            <p>${correctAnswer}</p>
                        </div>`;
                    }
                }

                reviewHtml += `
                    <div class="dark-card p-4">
                        <p class="text-lg font-bold flex justify-between">
                            Soal ${index + 1}
                            <span class="${isStudentCorrect ? 'text-green-400' : 'text-red-400'}">${isStudentCorrect ? 'BENAR' : 'SALAH'}</span>
                        </p>
                        <div class="text-gray-300 mt-2">${q.text}</div>
                        ${q.image ? `<img src="${q.image}" class="question-image mt-2">` : ''}
                        
                        ${examData.showReview ? answerHtml : ''}
                        
                        ${examData.showPembahasan && originalQ.pembahasan ? `
                            <div class="mt-4 p-3 border-t-2 border-blue-500 bg-blue-900/30 rounded-b-lg">
                                <p class="font-bold text-blue-300">Pembahasan:</p>
                                <div class="text-blue-200">${originalQ.pembahasan}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            container.innerHTML = reviewHtml;
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise([container]);
            }
        }


        function renderQuestionNavPanel() {
            const panel = document.getElementById('question-nav-panel');
            panel.innerHTML = '';

            studentExamData.questions.forEach((q, index) => {
                const studentAnswer = quizState.answers[q.id];
                let isAnswered = q.type === 'mc-complex' ? (Array.isArray(studentAnswer) && studentAnswer.length > 0) : !!studentAnswer;

                const isCurrent = index === quizState.currentQIndex;
                
                let bgColor = 'bg-gray-700 hover:bg-gray-600';
                if (isCurrent) bgColor = 'gradient-button';
                else if (isAnswered) bgColor = 'bg-green-600 hover:bg-green-500';

                panel.insertAdjacentHTML('beforeend', `
                    <button onclick="quizState.currentQIndex = ${index}; renderQuizQuestions();" class="${bgColor} text-white p-2 rounded-lg text-sm transition">
                        ${index + 1}
                    </button>
                `);
            });
        }
        
        // --- HYBRID / FIREBASE FUNCTIONS ---
        
        async function sendScoreOnline(submissionData) {
            if (!db || !userId) {
                console.warn("User not authenticated or DB not ready. Skipping online score submission.");
                return false;
            }
            
            try {
                const scorePath = `${EXAM_COLLECTION}/${submissionData.examId}/${SCORE_COLLECTION}`;
                const scoreRef = db.collection(scorePath);

                const dataToSend = {
                    studentId: submissionData.studentId,
                    studentName: submissionData.studentName,
                    studentClass: submissionData.studentClass,
                    score: submissionData.score,
                    correctCount: submissionData.correctCount,
                    needsManualReview: submissionData.needsManualReview,
                    finishTime: submissionData.finishTime,
                    answers: submissionData.answers,
                    strikes: submissionData.strikes,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await scoreRef.doc(submissionData.studentId).set(dataToSend);
                console.log("Skor berhasil dikirim ke server (Firestore).");
                return true;

            } catch (error) {
                console.error("Gagal mengirim skor ke server:", error);
                showConfirm("Gagal menyimpan hasil ujian ke server. Data tersimpan di perangkat lokal.", null, null, true);
                return false;
            }
        }
        
        // SINKRONISASI OTOMATIS
        async function syncOfflineScores() {
            if (!isOnline || !isAuthReady || !db) return;

            const unsyncedScores = scoreRecap.filter(score => score.synced === false && score.examId && !score.examId.startsWith('OFFLINE_EXAM_'));
            
            if (unsyncedScores.length > 0) {
                console.log(`Mencoba menyinkronkan ${unsyncedScores.length} nilai yang tertunda...`);
                for (const score of unsyncedScores) {
                    const success = await sendScoreOnline(score);
                    if (success) {
                        score.synced = true;
                    }
                }
                saveScoreRecap(); // Simpan status 'synced' yang baru
                console.log("Sinkronisasi selesai.");
            }
        }


        function saveAnswerKeyToLocal(fullExamData) {
            try {
                const key = ANSWER_KEY_PREFIX + fullExamData.examId;
                localStorage.setItem(key, JSON.stringify(fullExamData));
                console.log(`Kunci jawaban untuk ${fullExamData.examId} disimpan secara lokal.`);
            } catch (e) {
                console.error("Gagal menyimpan kunci jawaban lokal:", e);
                showConfirm("Gagal menyimpan kunci jawaban ke browser. Koreksi manual mungkin gagal.", null, null, true);
            }
        }
        
        async function publishExamOnline() {
            if (!db || !auth.currentUser) {
                showConfirm("Gagal: Koneksi ke server tidak stabil. Coba periksa koneksi internet Anda.", null, null, true);
                return;
            }
            
            examData.title = document.getElementById('exam-title-input').value.trim();
            examData.duration = parseInt(document.getElementById('exam-duration-input').value) || 60;
            examData.password = document.getElementById('exam-password-input').value.trim();
            examData.unlockCode = document.getElementById('exam-code-lock-input').value.trim();
            examData.maxStrikes = parseInt(document.getElementById('exam-strikes-input').value) || 3;
            examData.shuffleQuestions = document.getElementById('exam-shuffle-q-input').checked;
            examData.shuffleOptions = document.getElementById('exam-shuffle-o-input').checked;
            examData.showScore = document.getElementById('exam-show-score-input').checked;
            examData.limitAttempts = document.getElementById('exam-limit-attempts-input').checked;
            examData.showReview = document.getElementById('exam-show-review-input').checked;
            examData.showPembahasan = document.getElementById('exam-show-pembahasan-input').checked;
            const allowedClassesRaw = document.getElementById('exam-allowed-classes-input').value.trim();
            examData.allowedClasses = allowedClassesRaw ? allowedClassesRaw.split(',').map(c => c.trim().toUpperCase()) : [];


            if (!examData.title || examData.questions.length === 0) {
                showConfirm("Judul ujian dan minimal satu soal harus diisi.", null, null, true);
                return;
            }
            
            const examCode = (Math.random().toString(36).substring(2, 8)).toUpperCase();
            examData.examId = examCode;
            examData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
            
            try {
                const examRef = db.collection(EXAM_COLLECTION).doc(examCode);
                await examRef.set(examData);
                
                // PENTING: Simpan kunci jawaban ke localStorage browser guru
                saveAnswerKeyToLocal(examData);
                
                showConfirm(`Ujian berhasil dipublikasikan secara Online! Kode Ujian yang harus dibagikan ke siswa adalah: ${examCode}`, null, null, false);
                loadPublishedExams(); // Muat ulang daftar ujian
            } catch (error) {
                console.error("Error publishing exam:", error);
                
                var errorMessage = "Gagal memublikasikan ujian ke server. Silakan coba lagi.";
                if (error.code === 'permission-denied') {
                    errorMessage = "Gagal: Izin Firebase ditolak. Pastikan koneksi dan otorisasi stabil.";
                } else if (error.message && error.message.includes('A network error')) {
                    errorMessage = "Gagal: Terjadi masalah koneksi jaringan.";
                }
                
                showConfirm(errorMessage, null, null, true);
            }
        }
        
        // --- FUNGSI BARU: MUAT UJIAN LAMA ---
        async function loadPublishedExams() {
            if (!db || !isAuthReady) {
                // Jangan tampilkan pesan jika hanya dimuat di latar belakang
                return;
            }
            
            const listDiv = document.getElementById('published-exams-list');
            // Hanya tampilkan status loading jika user sedang melihat layar creator
            if (currentScreen === 'exam-creator-screen') {
                listDiv.innerHTML = '<p class="text-gray-500 italic">Memuat ujian dari server...</p>';
            }
            
            try {
                const query = db.collection(EXAM_COLLECTION).orderBy('timestamp', 'desc').limit(20);
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<p class="text-gray-500 italic">Belum ada ujian yang dipublikasikan.</p>';
                    return;
                }
                
                listDiv.innerHTML = ''; // Bersihkan loading
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const examId = doc.id;
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('id-ID') : 'Baru saja';
                    
                    const item = document.createElement('div');
                    item.className = 'dark-card p-3 flex justify-between items-center border-l-4 border-cyan-500 bg-gray-700/50';
                    item.innerHTML = `
                        <div class="flex-grow mr-4 overflow-hidden">
                            <p class="font-semibold text-white truncate">${data.title}</p>
                            <p class="text-xs text-gray-400">Kode: ${examId} | Kelas: ${data.allowedClasses.join(', ') || 'Semua'} | Dibuat: ${timestamp}</p>
                        </div>
                        <button onclick="loadExamForEditing('${examId}')" class="gradient-button-secondary py-1 px-3 rounded-lg text-sm flex-shrink-0">Muat</button>
                    `;
                    listDiv.appendChild(item);
                });

            } catch (error) {
                console.error("Gagal memuat ujian online:", error);
                listDiv.innerHTML = `<p class="text-red-400 italic">Gagal memuat ujian: ${error.message}</p>`;
            }
        }
        
        async function loadExamForEditing(examId) {
            showConfirm("Ini akan menimpa pengaturan dan daftar soal ujian Anda saat ini. Lanjutkan?", async () => {
                try {
                    const examRef = db.collection(EXAM_COLLECTION).doc(examId);
                    const doc = await examRef.get();
                    
                    if (doc.exists) {
                        examData = doc.data();
                        examData.examId = null; // Hapus ID agar ini disimpan sebagai ujian BARU
                        
                        renderExamQuestionList(); // Ini akan mengisi semua form dan daftar soal
                        
                        showConfirm(`Ujian '${examData.title}' berhasil dimuat. Anda sekarang dapat mengedit dan mempublikasikannya sebagai ujian baru.`, null, null, false);
                    } else {
                        showConfirm("Gagal memuat: Ujian dengan ID ini tidak ditemukan.", null, null, true);
                    }
                } catch (error) {
                    showConfirm(`Gagal memuat ujian: ${error.message}`, null, null, true);
                }
            }, null);
        }

        // --- FUNGSI AUTENTIKASI DAN INISIALISASI FIREBASE ---
        
        function onAuthReady() {
            console.log("Authentication is ready. Loading initial data.");
            isAuthReady = true;
            
            syncOfflineScores(); // Langsung coba sinkronisasi saat login berhasil

            if (currentScreen === 'student-manager-screen') {
                loadStudents();
            }
        }

        function initializeFirebase() {
            try {
                const userFirebaseConfig = {
                    apiKey: "AIzaSyBc-QjHvBNyYkeh9h06efRdfQPaV4hcbTo",
                    authDomain: "aplikasi-ujian-online-6c61c.firebaseapp.com",
                    projectId: "aplikasi-ujian-online-6c61c",
                    storageBucket: "aplikasi-ujian-online-6c61c.appspot.com",
                    messagingSenderId: "850428764297",
                    appId: "1:850428764297:web:d93a1e8396307cb1372658"
                };
                
                const firebaseConfig = userFirebaseConfig; 
                appId = 'default-app-id';

                console.log(`Firebase Project ID being used: ${firebaseConfig.projectId}`);

                if (!firebase.apps.length) { 
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();

                auth.onAuthStateChanged(async (user) => {
                    console.log('Auth state changed. User object:', user);
                    if (user) {
                        userId = user.uid;
                        console.log('User is authenticated. UID:', userId);
                        if (!isAuthReady) { onAuthReady(); } 
                    } else {
                        console.log('No user found, attempting to sign in anonymously.');
                        try {
                            await auth.signInAnonymously();
                        } catch (error) { 
                            console.error("Firebase sign-in failed:", error); 
                            showConfirm(`Gagal login ke server: ${error.message}. Fitur online tidak akan berfungsi.`, null, null, true);
                        }
                    }
                });
                
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showConfirm(`Gagal menginisialisasi Firebase: ${e.message}. Fitur online tidak akan berfungsi.`, null, null, true);
            }
        }
        
        // --- LIVE MONITORING & ANTI-CHEATING LOGIC ---
        
        // FUNGSI BARU: Kirim status real-time ke Firebase (dipanggil setiap 5 detik)
        async function sendLiveStatus(immediate = false) {
            if (!db || !studentExamData || studentExamData.examId.startsWith('OFFLINE_EXAM_')) return;

            const examId = studentExamData.examId;
            const studentId = studentExamData.studentId;
            const liveRef = db.collection(EXAM_COLLECTION).doc(examId).collection(LIVE_MONITORING_COLLECTION).doc(studentId);
            
            const totalQuestions = studentExamData.questions.length;
            const answeredCount = Object.keys(quizState.answers).filter(qId => {
                const answer = quizState.answers[qId];
                if (Array.isArray(answer)) return answer.length > 0;
                if (typeof answer === 'object' && answer !== null && (answer.text || answer.image)) return true;
                return !!answer;
            }).length;

            // Status fokus didapatkan dari listener window.onblur/onfocus
            const isFocused = document.hasFocus();

            const data = {
                studentName: studentExamData.studentName,
                studentClass: studentExamData.studentClass,
                questionIndex: quizState.currentQIndex + 1,
                answered: answeredCount,
                totalQuestions: totalQuestions,
                timeLeft: quizState.timeLeft,
                isFocused: isFocused,
                strikes: quizState.strikes,
                isLocked: quizState.isLocked,
                isFinalChance: studentExamData.isFinalChance || false, // FITUR BARU: Kirim status Final Chance
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await liveRef.set(data, { merge: true });
                if (immediate) console.log(`Live status sent for ${studentId}: Focused=${isFocused}`);
            } catch (error) {
                console.error("Failed to send live status:", error);
            }
        }
        
        // MEMULAI interval live status
        function startLiveStatus() {
            if (liveStatusInterval) clearInterval(liveStatusInterval);
            // Kirim status setiap 5 detik
            liveStatusInterval = setInterval(() => sendLiveStatus(false), 5000); 
            // Kirim status segera setelah memulai
            sendLiveStatus(true);
        }
        
        // MENGHENTIKAN interval live status dan membersihkan data
        async function stopLiveStatus(removeData = false) {
            if (liveStatusInterval) {
                clearInterval(liveStatusInterval);
                liveStatusInterval = null;
            }

            if (removeData && db && studentExamData && !studentExamData.examId.startsWith('OFFLINE_EXAM_')) {
                const examId = studentExamData.examId;
                const studentId = studentExamData.studentId;
                const liveRef = db.collection(EXAM_COLLECTION).doc(examId).collection(LIVE_MONITORING_COLLECTION).doc(studentId);
                try {
                    await liveRef.delete();
                    console.log(`Live status cleared for ${studentId}.`);
                } catch (error) {
                    console.error("Failed to clear live status:", error);
                }
            }
        }

        // FUNGSI UNTUK DETEKSI CURANG
        function handleCheatingDetection() {
            if (currentScreen !== 'student-exam-screen' || !studentExamData || quizState.isLocked) return;

            // Kirim status unfocused segera
            sendLiveStatus(true);

            quizState.strikes++;
            studentExamData.strikes = quizState.strikes;
            
            let isFinalStrike = false;

            if (studentExamData.isFinalChance && quizState.strikes > 0) {
                // Jika Final Chance, satu pelanggaran langsung blokir
                isFinalStrike = true;
            } else if (quizState.strikes >= examData.maxStrikes) {
                // Jika bukan Final Chance, blokir jika mencapai batas maksimal
                isFinalStrike = true;
            }

            if (isFinalStrike) {
                studentExamData.isLocked = true;
                quizState.isLocked = true;
                clearInterval(quizState.timer);
                stopLiveStatus(true); // Hentikan dan hapus live data saat diblokir
                
                showConfirm(`❌ UJIAN DIBLOKIR: Anda telah berpindah jendela/aplikasi ${quizState.strikes} kali. Hubungi Guru untuk mereset kesempatan Anda.`, null, () => submitExam(true), true);
                
                renderQuizQuestions();
            } else {
                showConfirm(`⚠️ PERINGATAN CURANG: Jangan berpindah jendela/aplikasi! Pelanggaran ke-${quizState.strikes} dari ${examData.maxStrikes}.`, null, null, true);
            }
        }

        async function resetStudentAttempt() {
            const examCode = document.getElementById('exam-id-for-reset').value.trim().toUpperCase();
            const studentNis = document.getElementById('student-nis-for-reset').value.trim();
            const authCode = document.getElementById('reset-auth-code-input').value.trim();
            
            if (!examCode || !studentNis || !authCode) {
                showConfirm("Kode Ujian, NIS Siswa, dan Kode Reset/Unlock harus diisi.", null, null, true);
                return;
            }

            // Mode ONLINE
            if (isOnline && db) {
                try {
                    const examRef = db.collection(EXAM_COLLECTION).doc(examCode);
                    const examDoc = await examRef.get();

                    if (!examDoc.exists) {
                        showConfirm("Kode Ujian tidak ditemukan di database online.", null, null, true);
                        return;
                    }
                    const onlineExamData = examDoc.data();
                    if (onlineExamData.unlockCode !== authCode && onlineExamData.resetCode !== authCode) {
                        showConfirm("Kode Reset/Unlock salah untuk ujian ini.", null, null, true);
                        return;
                    }

                    const studentRef = db.collection(STUDENT_COLLECTION).doc(studentNis);
                    const studentDoc = await studentRef.get();
                    
                    if (!studentDoc.exists) {
                        showConfirm(`Siswa dengan NIS ${studentNis} tidak ditemukan di database. Pastikan siswa sudah terdaftar di Manajemen Siswa.`, null, null, true);
                        return;
                    }
                    
                    const studentData = studentDoc.data();
                    const fullStudentId = getStudentIdentifier(studentData.name, studentNis, studentData.kelas);

                    const scorePath = `${EXAM_COLLECTION}/${examCode}/${SCORE_COLLECTION}`;
                    await db.collection(scorePath).doc(fullStudentId).delete();
                    
                    // Hapus data live monitoring jika ada siswa yang diblokir
                    const livePath = `${EXAM_COLLECTION}/${examCode}/${LIVE_MONITORING_COLLECTION}`;
                    await db.collection(livePath).doc(fullStudentId).delete();

                    showConfirm(`✅ Kesempatan ujian untuk ${studentData.name} (${studentNis}) pada ujian ${examCode} telah di-reset (Online). Siswa dapat mencoba ujian kembali.`, null, null, false);

                } catch(error) {
                    console.error("Gagal mereset ujian online:", error);
                    showConfirm(`Gagal mereset ujian online: ${error.message}`, null, null, true);
                }
            } 
            // Mode OFFLINE
            else {
                if (examData.unlockCode !== authCode && examData.resetCode !== authCode) {
                    showConfirm("Kode Reset/Unlock salah untuk ujian lokal.", null, null, true);
                    return;
                }

                const scoreIndex = scoreRecap.findIndex(score => {
                    const nisInScore = score.studentId.split('_')[1];
                    return nisInScore === studentNis.toUpperCase() && score.examTitle === examCode;
                });

                if (scoreIndex > -1) {
                    const studentName = scoreRecap[scoreIndex].studentName;
                    scoreRecap.splice(scoreIndex, 1);
                    saveScoreRecap();
                    showConfirm(`✅ Kesempatan ujian untuk ${studentName} (${studentNis}) telah di-reset (Offline).`, null, null, false);
                } else {
                    showConfirm(`Tidak ditemukan riwayat ujian untuk siswa dengan NIS ${studentNis} pada ujian lokal dengan judul "${examCode}".`, null, null, true);
                }
            }
        }
        
        // FUNGSI BARU: Reset Status Live dari Dashboard Monitoring
        async function resetStudentLiveStatus(examId, studentId, mode) {
            if (!db || !isAuthReady) {
                showConfirm("Koneksi server belum siap.", null, null, true);
                return;
            }
            
            const liveRef = db.collection(EXAM_COLLECTION).doc(examId).collection(LIVE_MONITORING_COLLECTION).doc(studentId);
            
            let dataToUpdate = {
                isLocked: false,
                strikes: 0,
                isFinalChance: mode === 'final_chance', // Set status Final Chance
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const actionText = mode === 'final_chance' ? 'DIBERI KESEMPATAN TERAKHIR (Final Chance).' : 'DIRESET PENUH.';

            showConfirm(`Anda yakin ingin mereset status curang siswa ${studentId} ${actionText}? Siswa harus me-refresh halaman ujian mereka.`, async () => {
                try {
                    await liveRef.set(dataToUpdate, { merge: true });
                    showConfirm(`✅ Status siswa ${studentId} berhasil ${actionText}.`, null, null, false);
                    
                    // Jika reset penuh, hapus juga skor agar bisa mengulang penuh (opsional)
                    if (mode === 'full_reset') {
                        const scorePath = `${EXAM_COLLECTION}/${examId}/${SCORE_COLLECTION}`;
                        await db.collection(scorePath).doc(studentId).delete();
                    }

                } catch (error) {
                    console.error("Gagal mereset status live:", error);
                    showConfirm(`Gagal mereset status live: ${error.message}`, null, null, true);
                }
            }, null, true);
        }

        
        // --- LIVE MONITORING SCREEN FUNCTIONS (BARU) ---
        
        async function loadLiveMonitoringExams() {
            const select = document.getElementById('live-exam-select');
            select.innerHTML = '<option value="">Pilih Ujian...</option>';
            
            if (!db || !isAuthReady) {
                select.innerHTML = '<option value="">Gagal terhubung ke server</option>';
                return;
            }
            
            try {
                // Ambil daftar ujian yang sudah dipublikasi
                const query = db.collection(EXAM_COLLECTION).orderBy('timestamp', 'desc').limit(20);
                const snapshot = await query.get();
                
                if (!snapshot.empty) {
                    snapshot.docs.forEach(doc => {
                        const exam = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = `${exam.title} (${doc.id})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Gagal memuat daftar ujian live:", error);
                select.innerHTML = '<option value="">Gagal memuat data</option>';
            }
        }
        
        function startLiveMonitoring(examId) {
            stopLiveMonitoring(); // Hentikan monitoring sebelumnya
            
            liveMonitoringExamId = examId;
            const tableContainer = document.getElementById('live-monitoring-table-container');
            const statusText = document.getElementById('live-monitoring-status-text');
            const table = document.getElementById('live-monitoring-table');

            if (!examId || !db || !isAuthReady) {
                table.classList.add('hidden');
                statusText.classList.remove('hidden');
                statusText.textContent = "Pilih ujian di atas untuk memulai monitoring.";
                return;
            }
            
            statusText.textContent = "Menunggu data siswa...";
            table.classList.remove('hidden');

            const livePath = `${EXAM_COLLECTION}/${examId}/${LIVE_MONITORING_COLLECTION}`;
            const liveRef = db.collection(livePath);

            // Pasang listener real-time (onSnapshot)
            liveMonitoringUnsubscribe = liveRef.onSnapshot(snapshot => {
                const liveData = [];
                let cheatingCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    liveData.push(data);
                    if (data.strikes > 0 || data.isLocked) {
                        cheatingCount++;
                    }
                });

                renderLiveMonitoringTable(liveData);
                document.getElementById('live-stat-total').textContent = liveData.length;
                document.getElementById('live-stat-cheating').textContent = cheatingCount;
                
                if (liveData.length === 0) {
                     statusText.textContent = "Belum ada siswa yang memulai ujian ini.";
                } else {
                     statusText.classList.add('hidden');
                }
                
            }, error => {
                console.error("Live monitoring error:", error);
                statusText.textContent = `Error: Gagal memuat data live. ${error.message}`;
                table.classList.add('hidden');
                statusText.classList.remove('hidden');
            });
            
        }

        function stopLiveMonitoring() {
            if (liveMonitoringUnsubscribe) {
                liveMonitoringUnsubscribe();
                liveMonitoringUnsubscribe = null;
            }
            liveMonitoringExamId = null;
        }
        
        function renderLiveMonitoringTable(liveData) {
            const table = document.getElementById('live-monitoring-table');
            const sortedData = liveData.sort((a, b) => a.studentName.localeCompare(b.studentName));
            
            let tableHtml = `
                <thead>
                    <tr>
                        <th>Nama Siswa</th>
                        <th>Kelas</th>
                        <th>Status Fokus</th>
                        <th>Soal Dijawab</th>
                        <th>Pelanggaran</th>
                        <th>Aksi</th>
                        <th>Terakhir Diperbarui</th>
                    </tr>
                </thead>
                <tbody>
            `;

            sortedData.forEach(data => {
                const examId = liveMonitoringExamId;
                const studentId = data.studentId;
                
                let statusText = 'Fokus';
                let statusClass = 'status-focused';
                
                if (data.isLocked) {
                    statusText = 'DIBLOKIR (Curang)';
                    statusClass = 'status-blocked';
                } else if (!data.isFocused) {
                    statusText = 'TIDAK FOKUS';
                    statusClass = 'status-unfocused';
                } else if (data.strikes > 0) {
                    statusClass = 'status-unfocused';
                }

                const answeredRatio = `${data.answered}/${data.totalQuestions}`;
                const lastUpdate = data.lastUpdate ? new Date(data.lastUpdate.toDate()).toLocaleTimeString('id-ID') : 'N/A';
                
                const minutes = String(Math.floor(data.timeLeft / 60)).padStart(2, '0');
                const seconds = String(data.timeLeft % 60).padStart(2, '0');
                const timeLeftDisplay = data.timeLeft > 0 ? `${minutes}:${seconds}` : 'Selesai';
                
                const nis = data.studentId.split('_')[1] || data.studentId;

                let actionButtons = '';
                if (data.isLocked) {
                    // Tombol untuk mereset blokir (Final Chance atau Penuh)
                    actionButtons = `
                        <button onclick="resetStudentLiveStatus('${examId}', '${studentId}', 'final_chance')" class="bg-yellow-500 hover:bg-yellow-600 text-black py-1 px-2 rounded-lg text-xs mr-1">Final Chance (1x)</button>
                        <button onclick="resetStudentLiveStatus('${examId}', '${studentId}', 'full_reset')" class="bg-teal-500 hover:bg-teal-600 text-white py-1 px-2 rounded-lg text-xs">Reset Penuh</button>
                    `;
                } else if (data.strikes > 0) {
                     // Tombol untuk memberi Final Chance walau belum terblokir (Peringatan terakhir)
                     actionButtons = `
                        <button onclick="resetStudentLiveStatus('${examId}', '${studentId}', 'final_chance')" class="bg-orange-500 hover:bg-orange-600 text-white py-1 px-2 rounded-lg text-xs">Beri Final Chance</button>
                    `;
                } else {
                    actionButtons = '---';
                }
                
                const strikeStatus = `${data.strikes} (${data.isLocked ? 'BLOKIR' : (data.isFinalChance ? 'FINAL' : 'NORMAL')})`;

                tableHtml += `
                    <tr>
                        <td class="text-white">${data.studentName} (${nis})</td>
                        <td class="text-gray-400">${data.studentClass}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td class="text-yellow-400">${answeredRatio}</td>
                        <td class="${data.strikes > 0 || data.isLocked ? 'text-red-400' : 'text-gray-400'}">${strikeStatus}</td>
                        <td class="whitespace-nowrap">${actionButtons}</td>
                        <td class="text-gray-400 text-xs">${lastUpdate} (Sisa: ${timeLeftDisplay})</td>
                    </tr>
                `;
            });

            tableHtml += `</tbody>`;
            table.innerHTML = tableHtml;
        }

        async function clearLiveMonitoringData() {
            showConfirm("Anda yakin ingin menghapus SEMUA data live monitoring yang sedang berjalan untuk semua ujian?", async () => {
                if (!db || !isAuthReady) {
                    showConfirm("Gagal: Koneksi server belum siap.", null, null, true);
                    return;
                }
                
                try {
                    const examSnapshot = await db.collection(EXAM_COLLECTION).get();
                    let deletedCount = 0;
                    
                    for (const examDoc of examSnapshot.docs) {
                        const examId = examDoc.id;
                        const liveRef = db.collection(EXAM_COLLECTION).doc(examId).collection(LIVE_MONITORING_COLLECTION);
                        const liveSnapshot = await liveRef.get();
                        
                        const batch = db.batch();
                        liveSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                            deletedCount++;
                        });
                        await batch.commit();
                    }
                    
                    stopLiveMonitoring();
                    renderLiveMonitoringTable([]);
                    showConfirm(`✅ Berhasil menghapus ${deletedCount} entri data live monitoring dari server.`, null, null, false);
                } catch (error) {
                    console.error("Gagal menghapus data live monitoring:", error);
                    showConfirm(`Gagal menghapus: ${error.message}`, null, null, true);
                }
            }, null, true);
        }

        // --- GEMINI API INTEGRATION ---
        // (Fungsi generateDistractor tetap sama)
        
        async function generateDistractor() {
            const btn = document.getElementById('generate-distractor-btn');
            const questionText = document.getElementById('question-text-input').value.trim();
            const optionElements = document.querySelectorAll('#mc-options-list > div');
            
            let correctAnswer = null;
            let existingOptions = [];
            
            if (!questionText) {
                showConfirm("Teks soal harus diisi sebelum membuat pengecoh.", null, null, true);
                return;
            }
            
            optionElements.forEach((div) => {
                const textarea = div.querySelector('textarea');
                const isCorrect = div.querySelector('input').checked;
                const text = textarea.value.trim();
                if (isCorrect && text) {
                    correctAnswer = text;
                } else if (text) {
                    existingOptions.push(text);
                }
            });

            if (!correctAnswer) {
                showConfirm("Anda harus menentukan setidaknya SATU kunci jawaban yang benar agar AI dapat membuat pengecoh.", null, null, true);
                return;
            }

            if (!API_KEY) {
                showConfirm("Kesalahan: Kunci API Gemini tidak ditemukan. Harap masukkan kunci Anda di variabel 'API_KEY' di dalam kode.", null, null, true);
                return;
            }

            btn.disabled = true;
            btn.textContent = "✨ AI Sedang Berpikir...";
            
            const prompt = `
                Anda adalah asisten pembuat soal ujian yang ahli.
                Berdasarkan soal dan kunci jawaban berikut, buatkan 3 opsi jawaban pengecoh (distractor) yang relevan, masuk akal, namun salah.
                
                Soal: "${questionText}"
                Kunci Jawaban Benar: "${correctAnswer}"
                
                Opsi yang sudah ada (jangan diulang): ${existingOptions.join('; ') || 'Tidak ada'}
                
                Berikan jawaban HANYA dalam format array JSON dari string, contoh: ["Pilihan A", "Pilihan B", "Pilihan C"]
            `;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "ARRAY", items: { type: "STRING" } },
                    temperature: 0.8
                }
            };

            const apiUrl = `${API_URL_BASE}/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`HTTP error ${response.status}: ${errorBody.error.message}`);
                }
                
                const result = await response.json();
                const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonString) {
                    const newDistractors = JSON.parse(jsonString);
                    
                    if (Array.isArray(newDistractors) && newDistractors.length > 0) {
                        newDistractors.forEach(text => {
                            if (text.trim() && !existingOptions.includes(text.trim())) {
                                addMcOption({ text: text.trim(), isCorrect: false });
                            }
                        });
                        showConfirm(`✅ Berhasil menambahkan ${newDistractors.length} opsi pengecoh dari AI.`, null, null, false);
                    } else {
                        showConfirm("AI tidak dapat menghasilkan pengecoh yang valid. Coba modifikasi teks soal/kunci jawaban.", null, null, true);
                    }
                } else {
                    throw new Error("Respons AI kosong atau tidak valid.");
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                showConfirm(`Gagal terhubung ke AI: ${error.message}. Periksa kunci API, koneksi, dan coba lagi.`, null, null, true);
            }

            btn.disabled = false;
            btn.textContent = "✨ Buat Pengecoh Otomatis (AI)";
        }


        // --- Network Status ---
        function updateNetworkStatus() {
            const statusIndicator = document.getElementById('network-status');
            isOnline = navigator.onLine;
            if (isOnline) {
                statusIndicator.textContent = "Online";
                statusIndicator.className = 'online';
                syncOfflineScores(); // Coba sinkronisasi saat kembali online
            } else {
                statusIndicator.textContent = "Offline";
                statusIndicator.className = 'offline';
            }
        }
        
        // --- ANALYTICS FUNCTIONS (BARU) ---
        function switchAnalyticsTab(tabName) {
            document.getElementById('tab-panel-exam').classList.toggle('hidden', tabName !== 'exam');
            document.getElementById('tab-panel-student').classList.toggle('hidden', tabName !== 'student');
            
            document.getElementById('tab-btn-exam').classList.toggle('text-blue-400', tabName === 'exam');
            document.getElementById('tab-btn-exam').classList.toggle('border-blue-400', tabName === 'exam');
            document.getElementById('tab-btn-exam').classList.toggle('text-gray-500', tabName !== 'exam');
            
            document.getElementById('tab-btn-student').classList.toggle('text-blue-400', tabName === 'student');
            document.getElementById('tab-btn-student').classList.toggle('border-blue-400', tabName === 'student');
            document.getElementById('tab-btn-student').classList.toggle('text-gray-500', tabName !== 'student');
        }

        async function loadAnalyticsExams() {
            const select = document.getElementById('analytics-exam-select');
            select.innerHTML = '<option value="">Memuat ujian...</option>';
            
            if (!db || !isAuthReady) {
                select.innerHTML = '<option value="">Gagal terhubung ke server</option>';
                return;
            }
            
            try {
                const query = db.collection(EXAM_COLLECTION).orderBy('timestamp', 'desc');
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    select.innerHTML = '<option value="">Belum ada ujian online</option>';
                    return;
                }
                
                select.innerHTML = '<option value="">Pilih Ujian...</option>';
                snapshot.docs.forEach(doc => {
                    const exam = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id; // Gunakan examId (kode) sebagai value
                    option.textContent = `${exam.title} (${doc.id})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Gagal memuat daftar ujian analitik:", error);
                select.innerHTML = '<option value="">Gagal memuat data</option>';
            }
        }
        
        async function runExamAnalysis() {
            const examId = document.getElementById('analytics-exam-select').value;
            if (!examId) {
                showConfirm("Silakan pilih ujian terlebih dahulu.", null, null, true);
                return;
            }
            
            if (!db || !isAuthReady) {
                showConfirm("Gagal terhubung ke server.", null, null, true);
                return;
            }

            try {
                // 1. Ambil data ujian (untuk daftar soal)
                const examRef = db.collection(EXAM_COLLECTION).doc(examId);
                const examDoc = await examRef.get();
                if (!examDoc.exists) {
                    showConfirm("Data ujian tidak ditemukan.", null, null, true);
                    return;
                }
                const exam = examDoc.data();
                const questionMap = new Map(exam.questions.map(q => [q.id, { text: q.text, answer: q.answer, type: q.type, correctCount: 0, tag_topik: q.tag_topik || 'N/A', options: q.options }]));

                // 2. Ambil semua nilai untuk ujian ini
                const scoresRef = db.collection(EXAM_COLLECTION).doc(examId).collection(SCORE_COLLECTION);
                const scoresSnapshot = await scoresRef.get();
                
                if (scoresSnapshot.empty) {
                    showConfirm("Belum ada siswa yang mengerjakan ujian ini.", null, null, true);
                    document.getElementById('exam-analytics-results').classList.add('hidden');
                    return;
                }

                let totalScore = 0;
                let highScore = 0;
                let lowScore = 100;
                const scoreDistribution = new Array(10).fill(0); // 0-10, 11-20, ... 91-100

                const scoresArray = scoresSnapshot.docs.map(doc => doc.data());
                
                scoresArray.forEach(result => {
                    const score = result.score || 0;
                    
                    totalScore += score;
                    if (score > highScore) highScore = score;
                    if (score < lowScore) lowScore = score;
                    
                    const scoreIndex = Math.floor((score - 1) / 10);
                    if(scoreIndex >= 0) scoreDistribution[scoreIndex]++;
                    
                    // Analisis butir soal
                    exam.questions.forEach(q => {
                        const studentAnswer = result.answers[q.id];
                        let isCorrect = false;
                        // (Logika pengecekan yang disederhanakan)
                        if (q.type === 'mc') isCorrect = (studentAnswer === q.answer);
                        else if (q.type === 'mc-complex') isCorrect = (Array.isArray(studentAnswer) && Array.isArray(q.answer) && studentAnswer.sort().join(',') === q.answer.sort().join(','));
                        else if (q.type === 'bs') isCorrect = (studentAnswer === q.answer);
                        
                        if (isCorrect && questionMap.has(q.id)) {
                            questionMap.get(q.id).correctCount++;
                        }
                    });
                });

                const totalStudents = scoresSnapshot.size;
                document.getElementById('stat-total-students').textContent = totalStudents;
                document.getElementById('stat-avg-score').textContent = (totalScore / totalStudents).toFixed(1);
                document.getElementById('stat-high-score').textContent = highScore;
                document.getElementById('stat-low-score').textContent = lowScore;

                // Hitung Daya Pembeda
                const sortedScores = scoresArray.sort((a, b) => b.score - a.score);
                const groupSize = Math.floor(totalStudents * 0.27); // Kelompok atas dan bawah 27%
                const highGroup = sortedScores.slice(0, groupSize);
                const lowGroup = sortedScores.slice(-groupSize);

                const questionStats = Array.from(questionMap.entries()).map(([qId, q]) => {
                    // Hitung Tingkat Kesukaran (P)
                    const P = (q.correctCount / totalStudents) * 100;

                    // Hitung Daya Pembeda (D)
                    let R_upper = 0;
                    highGroup.forEach(score => {
                        const studentAnswer = score.answers[qId];
                        if (q.type === 'mc' && studentAnswer === q.answer) R_upper++;
                        else if (q.type === 'mc-complex' && Array.isArray(studentAnswer) && Array.isArray(q.answer) && studentAnswer.sort().join(',') === q.answer.sort().join(',')) R_upper++;
                        else if (q.type === 'bs' && studentAnswer === q.answer) R_upper++;
                    });

                    let R_lower = 0;
                    lowGroup.forEach(score => {
                        const studentAnswer = score.answers[qId];
                        if (q.type === 'mc' && studentAnswer === q.answer) R_lower++;
                        else if (q.type === 'mc-complex' && Array.isArray(studentAnswer) && Array.isArray(q.answer) && studentAnswer.sort().join(',') === q.answer.sort().join(',')) R_lower++;
                        else if (q.type === 'bs' && studentAnswer === q.answer) R_lower++;
                    });
                    
                    // Daya Pembeda (D) = (R_upper - R_lower) / Group Size
                    const D = groupSize > 0 ? (R_upper - R_lower) / groupSize : 0;
                    
                    let rekomendasi = 'Baik';
                    if (P < 30) rekomendasi = 'Sulit (Perlu Review)';
                    else if (P > 70) rekomendasi = 'Mudah (Pertahankan)';

                    if (D < 0.20 && D >= 0) rekomendasi = 'Kurang Membedakan (Revisi)';
                    else if (D < 0) rekomendasi = 'Sangat Buruk (Buang/Kunci Salah)';

                    return {
                        ...q,
                        qId: qId,
                        P: P.toFixed(1),
                        D: D.toFixed(2),
                        Rekomendasi: rekomendasi
                    };
                });
                
                // Render Grafik Distribusi Nilai
                renderScoreDistributionChart(scoreDistribution);

                // Render Soal Paling Sulit/Mudah (berdasarkan P)
                questionStats.sort((a, b) => parseFloat(a.P) - parseFloat(b.P));
                const difficultList = document.getElementById('difficult-questions-list');
                difficultList.innerHTML = questionStats.slice(0, 5).map(q => `<div class="text-sm p-2 bg-gray-700 rounded"><strong>${q.P}%</strong> - ${q.text.substring(0, 50)}... (${q.tag_topik})</div>`).join('');
                
                const easyList = document.getElementById('easy-questions-list');
                easyList.innerHTML = questionStats.slice(-5).reverse().map(q => `<div class="text-sm p-2 bg-gray-700 rounded"><strong>${q.P}%</strong> - ${q.text.substring(0, 50)}... (${q.tag_topik})</div>`).join('');
                
                document.getElementById('exam-analytics-results').classList.remove('hidden');

            } catch (error) {
                console.error("Gagal menjalankan analisis:", error);
                showConfirm(`Gagal menjalankan analisis: ${error.message}`, null, null, true);
            }
        }
        
        async function runStudentAnalysis() {
            const nis = document.getElementById('analytics-student-nis').value.trim();
            if (!nis) {
                showConfirm("Silakan masukkan NIS siswa.", null, null, true);
                return;
            }
            
            if (!db || !isAuthReady) {
                showConfirm("Gagal terhubung ke server.", null, null, true);
                return;
            }
            
            try {
                // 1. Dapatkan data siswa
                const studentRef = db.collection(STUDENT_COLLECTION).doc(nis);
                const studentDoc = await studentRef.get();
                
                if (!studentDoc.exists) {
                    showConfirm("Siswa dengan NIS ini tidak ditemukan.", null, null, true);
                    document.getElementById('student-analytics-results').classList.add('hidden');
                    return;
                }
                
                const student = studentDoc.data();
                document.getElementById('student-profile-name').textContent = student.name;
                document.getElementById('student-profile-class').textContent = student.kelas;
                document.getElementById('student-profile-nis').textContent = `NIS: ${nis}`;
                document.getElementById('student-profile-photo').src = student.photoUrl || 'https://placehold.co/100x100/332d5c/a78bfa?text=Foto';
                
                // 2. Cari riwayat ujian siswa (dari rekap lokal, karena query lintas koleksi kompleks)
                // Ini bisa disempurnakan nanti dengan query server
                const studentIdKey = getStudentIdentifier(student.name, nis, student.kelas);
                const examHistory = scoreRecap
                    .filter(r => r.studentId === studentIdKey)
                    .sort((a, b) => a.startTime - b.startTime); // Urutkan dari yang terlama
                    
                if (examHistory.length === 0) {
                    document.getElementById('student-exam-history-list').innerHTML = '<p class="text-gray-500 italic">Siswa ini belum memiliki riwayat ujian.</p>';
                } else {
                     document.getElementById('student-exam-history-list').innerHTML = examHistory.map(r => `
                        <div class="p-3 bg-gray-700 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${r.examTitle}</p>
                                <p class="text-xs text-gray-400">${new Date(r.finishTime).toLocaleString('id-ID')}</p>
                            </div>
                            <p class="text-2xl font-bold ${r.score >= 70 ? 'text-green-400' : 'text-red-400'}">${r.score}</p>
                        </div>
                    `).join('');
                }
                
                // 3. Render Grafik Perkembangan
                const labels = examHistory.map(r => r.examTitle.substring(0, 15) + '...');
                const data = examHistory.map(r => r.score);
                renderStudentProgressChart(labels, data);
                
                document.getElementById('student-analytics-results').classList.remove('hidden');

            } catch (error) {
                 console.error("Gagal mencari siswa:", error);
                 showConfirm(`Gagal mencari siswa: ${error.message}`, null, null, true);
            }
        }
        
        // --- FUNGSI GRAFIK ---
        function renderScoreDistributionChart(data) {
            const ctx = document.getElementById('score-distribution-chart').getContext('2d');
            if (scoreDistributionChart) {
                scoreDistributionChart.destroy();
            }
            scoreDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-10', '11-20', '21-30', '31-40', '41-50', '51-60', '61-70', '71-80', '81-90', '91-100'],
                    datasets: [{
                        label: 'Jumlah Siswa',
                        data: data,
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: 'rgba(167, 139, 250, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#E5E7EB' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#E5E7EB' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#E5E7EB' } }
                    }
                }
            });
        }
        
        function renderStudentProgressChart(labels, data) {
            const ctx = document.getElementById('student-progress-chart').getContext('2d');
            if (studentProgressChart) {
                studentProgressChart.destroy();
            }
            studentProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nilai Ujian',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#E5E7EB' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#E5E7EB' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // --- PREVIEW MODAL FUNCTIONS (BARU) ---
        
        function hidePreviewModal() {
            document.getElementById('preview-modal').classList.add('hidden');
        }

        function previewQuestion(id) {
            const q = questionBank.find(q => q.id === id);
            if (!q) return;

            const modal = document.getElementById('preview-modal');
            const content = document.getElementById('preview-modal-content');
            
            // 1. Bersihkan dan isi konten
            content.innerHTML = ''; 

            let htmlContent = `
                <h3 class="text-2xl font-bold text-white mb-4">Pratinjau Soal (${q.type.toUpperCase()})</h3>
                
                <div class="dark-card p-4 mb-4 border-l-4 border-pink-500 border-t-0">
                    <p class="text-sm font-semibold text-gray-400 mb-1">Topik: ${q.tag_topik || 'Tidak Ada Tag'}</p>
                    <div id="preview-q-text" class="text-xl leading-relaxed mb-4">${q.text}</div>
                    ${q.image && q.image.startsWith('data:') ? `<img src="${q.image}" class="question-image mb-4" alt="Gambar Soal">` : ''}
                    
                    <h4 class="text-lg font-semibold text-gray-300 mt-6 mb-2">Opsi Jawaban & Kunci:</h4>
            `;

            if (q.type === 'mc' || q.type === 'mc-complex') {
                const correctAnswers = Array.isArray(q.answer) ? q.answer : [q.answer];
                
                htmlContent += `<div class="space-y-2">`;
                q.options.forEach((opt, index) => {
                    const isCorrect = correctAnswers.includes(opt.label);
                    const borderColor = isCorrect ? 'border-green-500' : 'border-gray-700';
                    const bgColor = isCorrect ? 'bg-green-900/30' : 'bg-gray-800/50';
                    
                    htmlContent += `
                        <div class="p-3 border-2 ${borderColor} ${bgColor} rounded-lg flex flex-col space-y-1">
                            <div class="flex items-center space-x-2">
                                <span class="font-bold w-6 text-center">${opt.label}.</span>
                                <span class="${isCorrect ? 'text-green-400 font-bold' : 'text-gray-300'}">${opt.text}</span>
                            </div>
                            ${opt.image && opt.image.startsWith('data:') ? `<img src="${opt.image}" class="option-image mt-2" alt="Gambar Opsi">` : ''}
                        </div>
                    `;
                });
                htmlContent += `</div>`;
            } else if (q.type === 'bs') {
                const correctAnswers = q.answer.split('');
                 htmlContent += `<div class="space-y-2">`;
                 q.options.forEach((stmt, index) => {
                     const isTrue = correctAnswers[index] === 'B';
                     const resultText = isTrue ? 'Benar' : 'Salah';
                     const borderColor = isTrue ? 'border-green-500' : 'border-yellow-500';
                     const textColor = isTrue ? 'text-green-400' : 'text-yellow-400';
                     
                     htmlContent += `
                         <div class="p-3 border-2 ${borderColor} bg-gray-800/50 rounded-lg">
                             <p class="text-gray-300">${stmt.text}</p>
                             ${stmt.image && stmt.image.startsWith('data:') ? `<img src="${stmt.image}" class="option-image mt-2" alt="Gambar Pernyataan">` : ''}
                             <p class="text-sm mt-2 ${textColor}">Kunci: <strong>${resultText}</strong></p>
                         </div>
                     `;
                 });
                 htmlContent += `</div>`;
            } else if (q.type.startsWith('essay')) {
                 htmlContent += `
                    <div class="p-3 border-2 border-purple-500 bg-gray-800/50 rounded-lg">
                        <p class="font-semibold text-purple-400">TIPE ESAI</p>
                        <p class="text-sm mt-1">Kunci Jawaban Pendek: ${q.answer === '[MANUAL]' ? 'Penilaian Manual' : q.answer}</p>
                    </div>
                 `;
            }
            
            // Pembahasan
            if (q.pembahasan) {
                 htmlContent += `
                    <h4 class="text-lg font-semibold text-blue-400 mt-6 mb-2">Pembahasan:</h4>
                    <div class="dark-card p-4 border-l-4 border-blue-500">${q.pembahasan}</div>
                 `;
            }
            
            htmlContent += `</div>`; // Close the main dark-card
            
            // 2. Injeksi Konten ke DOM
            content.innerHTML = htmlContent;
            
            // 3. Render MathJax (penting: hanya setelah konten ada di DOM)
            // Menggunakan setTimeout 0 untuk memastikan DOM di-update
            setTimeout(() => {
                if (window.MathJax && MathJax.typesetPromise) {
                    MathJax.typesetPromise([content]).catch(err => console.error("MathJax error in preview:", err));
                }
            }, 0);
            
            // 4. Tampilkan Modal
            modal.classList.remove('hidden');
        }


        // --- MAIN INITIALIZATION ---
        window.onload = function() {
            // TIDAK PERLU Object.assign(window, {...}) karena fungsi dideklarasikan secara global
            // dan akan di-hoist. Ini memperbaiki ReferenceError: showScreen is not defined.

            updateNetworkStatus();
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            
            // Listener untuk Anti-Cheating
            window.addEventListener('blur', handleCheatingDetection);
            // Listener untuk mengirim status fokus (jika kembali fokus)
            window.addEventListener('focus', () => {
                if (currentScreen === 'student-exam-screen' && !studentExamData.examId.startsWith('OFFLINE_EXAM_')) {
                    sendLiveStatus(true);
                }
            });

            initializeFirebase();
            showScreen('student-landing-screen'); 
            
            setTimeout(() => {
                document.getElementById('start-exam-flow-button').addEventListener('click', startExamFlow);
                document.getElementById('find-student-btn').addEventListener('click', findStudentByNis);
                
                document.getElementById('prev-question-btn').addEventListener('click', () => {
                    if (studentExamData?.isLocked) return;
                    if (quizState.currentQIndex > 0) {
                        const currentQ = studentExamData.questions[quizState.currentQIndex];
                        if (currentQ.type === 'essay' || currentQ.type === 'essay-complex') { saveEssayAnswer(document.getElementById('essay-answer-input').value, currentQ.id); }
                        quizState.currentQIndex--;
                        renderQuizQuestions();
                    }
                });

                document.getElementById('next-question-btn').addEventListener('click', () => {
                    if (studentExamData?.isLocked) return;
                    if (quizState.currentQIndex < studentExamData.questions.length - 1) {
                        const currentQ = studentExamData.questions[quizState.currentQIndex];
                        if (currentQ.type === 'essay' || currentQ.type === 'essay-complex') { saveEssayAnswer(document.getElementById('essay-answer-input').value, currentQ.id); }
                        quizState.currentQIndex++;
                        renderQuizQuestions();
                    }
                });
                
                document.getElementById('finish-exam-btn').addEventListener('click', () => {
                    if (studentExamData?.isLocked) {
                        submitExam(true);
                        return;
                    }
                    submitExam(false);
                });
                
                document.getElementById('math-keyboard').addEventListener('click', function(event) {
                    const target = event.target.closest('button');
                    if (target && target.dataset.insert && currentEditingTextarea) {
                        insertAtCursor(currentEditingTextarea, target.dataset.insert);
                        currentEditingTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });

                document.getElementById('question-type').addEventListener('change', () => {
                    const type = document.getElementById('question-type').value;
                    document.getElementById('mc-options-container').style.display = (type === 'mc' || type === 'mc-complex') ? 'block' : 'none';
                    document.getElementById('essay-answer-container').style.display = type === 'essay' ? 'block' : 'none';
                    document.getElementById('bs-container').style.display = type === 'bs' ? 'block' : 'none';
                    
                    document.getElementById('mc-option-mode-text').textContent = (type === 'mc-complex' ? 'Pilihan Ganda Kompleks' : 'Pilihan Ganda');
                    
                    const list = document.getElementById('mc-options-list');
                    const optionsData = [];
                    list.querySelectorAll('#mc-options-list > div').forEach((div) => {
                        const textarea = div.querySelector('textarea');
                        const input = div.querySelector('input[type="radio"], input[type="checkbox"]');
                        if (textarea && input) {
                            const imagePreview = div.querySelector('img');
                            const image = imagePreview && !imagePreview.classList.contains('hidden') ? imagePreview.src : null;
                            optionsData.push({ text: textarea.value, isCorrect: input.checked, image: image });
                        }
                    });

                    list.innerHTML = '';
                    
                    if (optionsData.length === 0 && (type === 'mc' || type === 'mc-complex')) {
                         for (let i = 0; i < 4; i++) addMcOption();
                    } else {
                        optionsData.forEach(opt => addMcOption(opt));
                    }
                });

                const teacherPinInput = document.getElementById('teacher-pin-input');
                if (teacherPinInput) {
                    teacherPinInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            checkTeacherPin();
                        }
                    });
                    // PERBAIKAN: Otomatis masuk setelah 4 digit
                    teacherPinInput.addEventListener('input', (event) => {
                        if (event.target.value.length === 4) {
                            checkTeacherPin();
                        }
                    });
                }
                
                loadQuestionBank();
                loadScoreRecap();
                
            }, 100);

        };
    </script>
</body>
</html>
